<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Статистика тикетів</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-[#050608] text-[#FFFBEF] font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-[#1977FD]">Ласкаво просимо!</h1>
    <div id="login-section">
      <p class="mb-2">Будь ласка, авторизуйтесь через Telegram:</p>
      <script async src="https://telegram.org/js/telegram-widget.js?7"
              data-telegram-login="ticket_tracker_UG_bot" 
              data-size="large"
              data-userpic="false"
              data-request-access="write"
              data-onauth="onTelegramAuth(user)">
      </script>
    </div>

    <div id="dashboard" class="hidden">
      <h2 class="text-xl font-semibold mb-2 text-[#1977FD]">Ваша статистика:</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
          <h3 class="font-bold mb-2 text-[#1977FD]">Вчора</h3>
          <p>Тікети: <span id="today-tickets">—</span></p>
          <p>Час у грі: <span id="today-time">—</span></p>
        </div>
        <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
          <h3 class="font-bold mb-2 text-[#1977FD]">Тиждень</h3>
          <p>Тікети: <span id="week-tickets">—</span></p>
          <p>Час у грі: <span id="week-time">—</span></p>
        </div>
        <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
          <h3 class="font-bold mb-2 text-[#1977FD]">Місяць</h3>
          <p>Тікети: <span id="month-tickets">—</span></p>
          <p>Час у грі: <span id="month-time">—</span></p>
        </div>
      </div>

      <div class="bg-[#101214] p-4 rounded shadow mb-6 text-[#FFFBEF]">
        <h3 class="font-bold mb-4 text-[#1977FD]">Динаміка тікетів і часу за останній місяць</h3>
        <canvas id="statsChart" height="150"></canvas>
      </div>

      <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
        <h3 class="font-bold mb-2 text-[#1977FD]">Детальна статистика по днях:</h3>
        <table class="min-w-full text-left border-collapse text-sm">
          <thead>
            <tr>
              <th class="border border-[#1977FD] px-2 py-1">Дата</th>
              <th class="border border-[#1977FD] px-2 py-1">Тікети</th>
              <th class="border border-[#1977FD] px-2 py-1">Час у грі</th>
              <th class="border border-[#1977FD] px-2 py-1">Неактив</th>
            </tr>
          </thead>
          <tbody id="daily-stats-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Админ-панель, скрыта по умолчанию -->
    <div id="admin-panel" class="hidden mt-8 bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
      <h2 class="text-xl font-semibold mb-4 text-[#1977FD]">Админ-панель: Статистика всіх співробітників</h2>
      <table class="min-w-full text-left border-collapse text-sm">
        <thead>
          <tr>
            <th class="border border-[#1977FD] px-2 py-1">Ім'я</th>
            <th class="border border-[#1977FD] px-2 py-1">Telegram</th>
            <th class="border border-[#1977FD] px-2 py-1">Годин за місяць</th>
            <th class="border border-[#1977FD] px-2 py-1">Тікети за вчора</th>
            <th class="border border-[#1977FD] px-2 py-1">Тікети за тиждень</th>
            <th class="border border-[#1977FD] px-2 py-1">Тікети за місяць</th>
          </tr>
        </thead>
        <tbody id="admin-stats-body"></tbody>
      </table>
    </div>
  </div>

<script>
  const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU'; 
  const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';   

  // Список админов (укажите свои Telegram username с @)
  const ADMINS = ['@admin_user1', '@admin_user2', '@yourusername'];

  async function getSheetData(sheetName) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
    const res = await axios.get(url);
    return res.data.values;
  }

  function parseDate(str) {
    const [d, m, y] = str.split('.');
    return new Date(`${y}-${m}-${d}`);
  }

  function formatDate(date) {
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yyyy = date.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  }

  function secondsToHHMMSS(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? `${h}ч ${m}м` : `${m}м`;
  }

  async function fetchUserStatsByTelegram(telegramUsername) {
    try {
      const ticketsData = await getSheetData('Май_2025_таблица');
      const timeData = await getSheetData('Время_в_игре');

      const ticketsHeaders = ticketsData[0];
      const telegramColIndex = ticketsHeaders.indexOf('Telegram');
      const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

      const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === telegramUsername);
      if (!userTicketsRow) {
        alert('Пользователь не найден в таблице тикетов');
        return;
      }

      const userName = userTicketsRow[nameColIndex];

      const timeHeaders = timeData[0];
      const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
      const userTimeRow = timeData.find(row => row[timeNameColIndex] === userName);
      if (!userTimeRow) {
        alert('Пользователь не найден в таблице времени');
        return;
      }

      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);

      // Даты из заголовков листа с тикетами
      const dateCols = ticketsHeaders
        .map((h, i) => ({h, i}))
        .filter(({h}) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

      function sumTicketsAndTime(startDate, endDate, ticketsRow, timeRow) {
        let ticketsSum = 0;
        let timeSecondsSum = 0;

        dateCols.forEach(({h, i}) => {
          const dt = parseDate(h);
          if (dt >= startDate && dt <= endDate) {
            ticketsSum += parseInt(ticketsRow[i]) || 0;
            const timeColIndex = timeHeaders.indexOf(h);
            if (timeColIndex >= 0) {
              const timeStr = timeRow[timeColIndex];
              if (timeStr && timeStr !== 'Н') {
                const [hh, mm, ss] = timeStr.split(':').map(Number);
                timeSecondsSum += hh * 3600 + mm * 60 + ss;
              }
            }
          }
        });

        return {ticketsSum, timeSecondsSum};
      }

      // Вчора
      const yesterdayStats = sumTicketsAndTime(yesterday, yesterday, userTicketsRow, userTimeRow);
      // Тиждень (7 днів включно до вчора)
      const weekStart = new Date(yesterday.getTime() - 6 * 24*60*60*1000);
      const weekStats = sumTicketsAndTime(weekStart, yesterday, userTicketsRow, userTimeRow);
      // Місяць (30 днів включно до вчора)
      const monthStart = new Date(yesterday.getTime() - 29 * 24*60*60*1000);
      const monthStats = sumTicketsAndTime(monthStart, yesterday, userTicketsRow, userTimeRow);

      // Обновляем UI для обычного пользователя
      document.getElementById('today-tickets').innerText = yesterdayStats.ticketsSum;
      document.getElementById('today-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);
      document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
      document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);
      document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
      document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

      // Таблица детальной статистики по дням (за месяц)
      const tbody = document.getElementById('daily-stats-body');
      tbody.innerHTML = '';

      let inactiveCount = 0;

      const chartLabels = [];
      const chartTickets = [];
      const chartTimeHours = [];

      dateCols.forEach(({h, i}) => {
        const dt = parseDate(h);
        if (dt >= monthStart && dt <= yesterday) {
          const dayTickets = parseInt(userTicketsRow[i]) || 0;
          const timeColIndex = timeHeaders.indexOf(h);
          let dayTimeStr = 'Н';
          let dayTimeSeconds = 0;
          if (timeColIndex >= 0) {
            dayTimeStr = userTimeRow[timeColIndex] || 'Н';
            if (dayTimeStr !== 'Н') {
              const [hh, mm, ss] = dayTimeStr.split(':').map(Number);
              dayTimeSeconds = hh * 3600 + mm * 60 + ss;
            }
          }
          if (dayTimeStr === 'Н') inactiveCount++;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border px-2 py-1">${h}</td>
            <td class="border px-2 py-1">${dayTickets}</td>
            <td class="border px-2 py-1">${dayTimeStr}</td>
            <td class="border px-2 py-1">${dayTimeStr === 'Н' ? 'Да' : ''}</td>
          `;
          tbody.appendChild(tr);

          chartLabels.push(h);
          chartTickets.push(dayTickets);
          chartTimeHours.push((dayTimeSeconds / 3600).toFixed(2));
        }
      });

      // Итог по неактивам
      const trTotal = document.createElement('tr');
      trTotal.innerHTML = `
        <td class="border px-2 py-1 font-bold">Неактив за місяць</td>
        <td colspan="3" class="border px-2 py-1 font-bold">${inactiveCount}</td>
      `;
      tbody.appendChild(trTotal);

      // Рисуем график
      renderChart(chartLabels, chartTickets, chartTimeHours);

      // Если админ — показываем панель админа
      if (ADMINS.includes(telegramUsername)) {
        document.getElementById('admin-panel').classList.remove('hidden');
        fetchAdminStats();
      }
    } catch (err) {
      alert('Помилка при завантаженні даних: ' + err.message);
      console.error(err);
    }
  }

  async function fetchAdminStats() {
    try {
      const ticketsData = await getSheetData('Май_2025_таблица');
      const timeData = await getSheetData('Время_в_игре');

      const ticketsHeaders = ticketsData[0];
      const telegramColIndex = ticketsHeaders.indexOf('Telegram');
      const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

      const timeHeaders = timeData[0];
      const dateCols = ticketsHeaders
        .map((h, i) => ({h, i}))
        .filter(({h}) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);

      const monthStart = new Date(yesterday.getTime() - 29 * 24*60*60*1000);
      const weekStart = new Date(yesterday.getTime() - 6 * 24*60*60*1000);

      function sumTicketsAndTimeForRow(startDate, endDate, ticketsRow, timeRow) {
        let ticketsSum = 0;
        let timeSecondsSum = 0;

        dateCols.forEach(({h, i}) => {
          const dt = parseDate(h);
          if (dt >= startDate && dt <= endDate) {
            ticketsSum += parseInt(ticketsRow[i]) || 0;
            const timeColIndex = timeHeaders.indexOf(h);
            if (timeColIndex >= 0) {
              const timeStr = timeRow[timeColIndex];
              if (timeStr && timeStr !== 'Н') {
                const [hh, mm, ss] = timeStr.split(':').map(Number);
                timeSecondsSum += hh * 3600 + mm * 60 + ss;
              }
            }
          }
        });

        return {ticketsSum, timeSecondsSum};
      }

      const tbody = document.getElementById('admin-stats-body');
      tbody.innerHTML = '';

      // Перебираем всех пользователей из тикетов
      for (let i = 1; i < ticketsData.length; i++) {
        const row = ticketsData[i];
        const telegramUsername = row[telegramColIndex];
        const userName = row[nameColIndex];
        const timeRow = timeData.find(r => r[timeHeaders.indexOf('Имя сотрудника')] === userName);
        if (!timeRow) continue;

        // Подсчёт по временным промежуткам
        const monthStats = sumTicketsAndTimeForRow(monthStart, yesterday, row, timeRow);
        const weekStats = sumTicketsAndTimeForRow(weekStart, yesterday, row, timeRow);
        const yesterdayStats = sumTicketsAndTimeForRow(yesterday, yesterday, row, timeRow);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1">${userName}</td>
          <td class="border px-2 py-1">${telegramUsername}</td>
          <td class="border px-2 py-1">${(monthStats.timeSecondsSum/3600).toFixed(2)} год.</td>
          <td class="border px-2 py-1">${yesterdayStats.ticketsSum}</td>
          <td class="border px-2 py-1">${weekStats.ticketsSum}</td>
          <td class="border px-2 py-1">${monthStats.ticketsSum}</td>
        `;
        tbody.appendChild(tr);
      }
    } catch (err) {
      alert('Помилка при завантаженні даних адміна: ' + err.message);
      console.error(err);
    }
  }

  let statsChart = null;
  function renderChart(labels, tickets, timeHours) {
    const ctx = document.getElementById('statsChart').getContext('2d');
    if (statsChart) statsChart.destroy();
    statsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Тікети',
            data: tickets,
            backgroundColor: '#1977FD',
            yAxisID: 'y1',
          },
          {
            label: 'Години в грі',
            data: timeHours,
            type: 'line',
            borderColor: '#F59E0B',
            fill: false,
            yAxisID: 'y2',
          },
        ]
      },
      options: {
        responsive: true,
        interaction: {mode: 'index', intersect: false},
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            beginAtZero: true,
            title: {display: true, text: 'Тікети'}
          },
          y2: {
            type: 'linear',
            position: 'right',
            beginAtZero: true,
            title: {display: true, text: 'Години'},
            grid: {drawOnChartArea: false}
          }
        }
      }
    });
  }

  function onTelegramAuth(user) {
    const username = '@' + user.username;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    fetchUserStatsByTelegram(username);
  }
</script>
</body>
</html>
