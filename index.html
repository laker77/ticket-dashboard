<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Статистика тикетів</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-[#050608] text-[#FFFBEF] font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-[#1977FD]" id="welcome-header">Ласкаво просимо!</h1>

    <!-- Секция входа -->
    <div id="login-section">
      <p class="mb-2">Будь ласка, авторизуйтесь через Telegram:</p>
      <script async src="https://telegram.org/js/telegram-widget.js?7"
              data-telegram-login="ticket_tracker_UG_bot" 
              data-size="large"
              data-userpic="false"
              data-request-access="write"
              data-onauth="onTelegramAuth(user)">
      </script>
    </div>

    <!-- Пользовательский дашборд -->
    <div id="dashboard" class="hidden">
      <h2 class="text-xl font-semibold mb-2 text-[#1977FD]">Ваша статистика:</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
          <h3 class="font-bold mb-2 text-[#1977FD]">Вчора</h3>
          <p>Тікети: <span id="yesterday-tickets">—</span></p>
          <p>Час у грі: <span id="yesterday-time">—</span></p>
        </div>
        <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
          <h3 class="font-bold mb-2 text-[#1977FD]">Тиждень</h3>
          <p>Тікети: <span id="week-tickets">—</span></p>
          <p>Час у грі: <span id="week-time">—</span></p>
        </div>
        <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
          <h3 class="font-bold mb-2 text-[#1977FD]">Місяць</h3>
          <p>Тікети: <span id="month-tickets">—</span></p>
          <p>Час у грі: <span id="month-time">—</span></p>
        </div>
      </div>

      <div class="bg-[#101214] p-4 rounded shadow mb-6 text-[#FFFBEF]">
        <h3 class="font-bold mb-4 text-[#1977FD]">Динаміка тікетів і часу за останній місяць</h3>
        <canvas id="statsChart" height="150"></canvas>
      </div>

      <div class="bg-[#101214] p-4 rounded shadow text-[#FFFBEF]">
        <h3 class="font-bold mb-2 text-[#1977FD]">Детальна статистика по днях:</h3>
        <table class="min-w-full text-left border-collapse text-sm">
          <thead>
            <tr>
              <th class="border border-[#1977FD] px-2 py-1">Дата</th>
              <th class="border border-[#1977FD] px-2 py-1">Тікети</th>
              <th class="border border-[#1977FD] px-2 py-1">Час у грі</th>
              <th class="border border-[#1977FD] px-2 py-1">Неактив</th>
            </tr>
          </thead>
          <tbody id="daily-stats-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Админ панель -->
    <div id="admin-panel" class="hidden">
      <h2 class="text-xl font-bold mb-4 text-[#1977FD]">Адмін панель</h2>
      <div id="admin-content" class="overflow-x-auto"></div>
    </div>
  </div>

<script>
  const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU';
  const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';

  // Список админов по Telegram username (без @)
  const admins = ['laker_77', 'admin_username2'];

  async function getSheetData(sheetName) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
    const res = await axios.get(url);
    return res.data.values;
  }

  function parseDate(str) {
    const [d, m, y] = str.split('.');
    return new Date(`${y}-${m}-${d}`);
  }

  function formatDate(date) {
    const dd = String(date.getDate()).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const yyyy = date.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  }

  function secondsToHHMMSS(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return h > 0 ? `${h}ч ${m}м` : `${m}м`;
  }

  async function fetchUserStatsByTelegram(telegramUsername) {
    try {
      const ticketsData = await getSheetData('Май_2025_таблица');
      const timeData = await getSheetData('Время_в_игре');

      const ticketsHeaders = ticketsData[0];
      const telegramColIndex = ticketsHeaders.indexOf('Telegram');
      const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

      const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === '@' + telegramUsername);
      if (!userTicketsRow) {
        alert('Пользователь не найден в таблице тикетов');
        return;
      }

      const userNameInGame = userTicketsRow[nameColIndex]; // Имя в игре для приветствия

      const timeHeaders = timeData[0];
      const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
      const userTimeRow = timeData.find(row => row[timeNameColIndex] === userNameInGame);
      if (!userTimeRow) {
        alert('Пользователь не найден в таблице времени');
        return;
      }

      const today = new Date();
      const yesterday = new Date(today.getTime() - 24*60*60*1000);
      const yesterdayStr = formatDate(yesterday);

      // Даты из заголовков листа с тикетами
      const dateCols = ticketsHeaders
        .map((h, i) => ({h, i}))
        .filter(({h}) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

      function sumTicketsAndTime(startDate, endDate) {
        let ticketsSum = 0;
        let timeSecondsSum = 0;

        dateCols.forEach(({h, i}) => {
          const dt = parseDate(h);
          if (dt >= startDate && dt <= endDate) {
            ticketsSum += parseInt(userTicketsRow[i]) || 0;
            const timeColIndex = timeHeaders.indexOf(h);
            if (timeColIndex >= 0) {
              const timeStr = userTimeRow[timeColIndex];
              if (timeStr && timeStr !== 'Н') {
                const [hh, mm, ss] = timeStr.split(':').map(Number);
                timeSecondsSum += hh * 3600 + mm * 60 + ss;
              }
            }
          }
        });

        return {ticketsSum, timeSecondsSum};
      }

      // Вчора
      const yesterdayStats = sumTicketsAndTime(yesterday, yesterday);
      // Неделя (7 дней включая вчера)
      const weekStart = new Date(yesterday.getTime() - 6 * 24*60*60*1000);
      const weekStats = sumTicketsAndTime(weekStart, yesterday);
      // Месяц (30 дней включая вчера)
      const monthStart = new Date(yesterday.getTime() - 29 * 24*60*60*1000);
      const monthStats = sumTicketsAndTime(monthStart, yesterday);

      // Обновляем UI
      document.getElementById('yesterday-tickets').innerText = yesterdayStats.ticketsSum;
      document.getElementById('yesterday-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);
      document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
      document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);
      document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
      document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

      document.getElementById('welcome-header').innerText = `Вітаю, ${userNameInGame}!`;

      renderDailyStats(userTicketsRow, userTimeRow, dateCols, yesterday);
      renderChart(userTicketsRow, userTimeRow, dateCols);

    } catch (error) {
      console.error(error);
      alert('Сталася помилка при отриманні даних.');
    }
  }

  function renderDailyStats(ticketsRow, timeRow, dateCols, yesterday) {
    const tbody = document.getElementById('daily-stats-body');
    tbody.innerHTML = '';

    // Сортируем даты по возрастанию
    const sortedDates = [...dateCols].sort((a, b) => parseDate(a.h) - parseDate(b.h));

    sortedDates.forEach(({h, i}) => {
      // Пропускаем сегодняшнюю дату, чтобы показывать до вчера
      if (parseDate(h) > yesterday) return;

      const tickets = parseInt(ticketsRow[i]) || 0;
      const timeStr = timeRow[i] || 'Н';
      const isInactive = timeStr === 'Н';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border border-[#1977FD] px-2 py-1">${h}</td>
        <td class="border border-[#1977FD] px-2 py-1">${tickets}</td>
        <td class="border border-[#1977FD] px-2 py-1">${timeStr}</td>
        <td class="border border-[#1977FD] px-2 py-1">${isInactive ? 'Так' : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderChart(ticketsRow, timeRow, dateCols) {
    const ctx = document.getElementById('statsChart').getContext('2d');
    if (window.statsChartInstance) {
      window.statsChartInstance.destroy();
    }

    // Сортируем даты по возрастанию
    const sortedDates = [...dateCols].sort((a, b) => parseDate(a.h) - parseDate(b.h));

    const labels = [];
    const ticketsData = [];
    const timeData = [];

    sortedDates.forEach(({h, i}) => {
      labels.push(h);
      ticketsData.push(parseInt(ticketsRow[i]) || 0);

      const timeStr = timeRow[i];
      if (!timeStr || timeStr === 'Н') {
        timeData.push(0);
      } else {
        const [hh, mm, ss] = timeStr.split(':').map(Number);
        timeData.push(hh * 3600 + mm * 60 + ss);
      }
    });

    window.statsChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Тікети',
            data: ticketsData,
            borderColor: '#1977FD',
            backgroundColor: 'rgba(25, 119, 253, 0.2)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 5,
          },
          {
            label: 'Час у грі (сек)',
            data: timeData,
            borderColor: '#33cc33',
            backgroundColor: 'rgba(51, 204, 51, 0.2)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 5,
          },
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
          }
        }
      }
    });
  }

  // Админка: загрузка всех пользователей и вывод таблицы
  async function loadAdminData() {
    try {
      const ticketsData = await getSheetData('Май_2025_таблица');
      const timeData = await getSheetData('Время_в_игре');

      const ticketHeaders = ticketsData[0];
      const telegramIdx = ticketHeaders.indexOf('Telegram');
      const nameIdx = ticketHeaders.indexOf('Имя сотрудника');

      let html = '<table class="min-w-full text-left border-collapse text-sm">';
      html += `
        <thead>
          <tr>
            <th class="border border-[#1977FD] px-2 py-1">Ім’я</th>
            <th class="border border-[#1977FD] px-2 py-1">Telegram</th>
            <th class="border border-[#1977FD] px-2 py-1">Тікети за місяць</th>
          </tr>
        </thead><tbody>`;

      // Даты для подсчёта месяца
      const dateCols = ticketHeaders
        .map((h, i) => ({h, i}))
        .filter(({h}) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

      // Для каждого пользователя подсчёт тикетов за весь месяц (последние 30 дней)
      ticketsData.slice(1).forEach(row => {
        const ticketsSum = dateCols.reduce((sum, {i}) => sum + (parseInt(row[i]) || 0), 0);
        html += `<tr>
          <td class="border px-2 py-1">${row[nameIdx]}</td>
          <td class="border px-2 py-1">${row[telegramIdx]}</td>
          <td class="border px-2 py-1">${ticketsSum}</td>
        </tr>`;
      });

      html += '</tbody></table>';

      document.getElementById('admin-content').innerHTML = html;
    } catch (e) {
      document.getElementById('admin-content').innerText = 'Помилка при завантаженні даних.';
      console.error(e);
    }
  }

  // Вызов при авторизации через Telegram
  function onTelegramAuth(user) {
    document.getElementById('login-section').classList.add('hidden');

    if (admins.includes(user.username)) {
      document.getElementById('admin-panel').classList.remove('hidden');
      loadAdminData();
    } else {
      document.getElementById('dashboard').classList.remove('hidden');
      fetchUserStatsByTelegram(user.username);
    }
  }

  window.onTelegramAuth = onTelegramAuth; // сделать функцию глобальной для Telegram виджета

</script>
</body>
</html>
