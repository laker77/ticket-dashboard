<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Статистика тікетів</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Ласкаво просимо!</h1>
    <div id="login-section">
      <p class="mb-2">Будь ласка, увійдіть через Telegram:</p>
      <script async src="https://telegram.org/js/telegram-widget.js?7"
              data-telegram-login="ticket_tracker_UG_bot" 
              data-size="large"
              data-userpic="false"
              data-request-access="write"
              data-onauth="onTelegramAuth(user)">
      </script>
    </div>
    <div id="dashboard" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Ваша статистика:</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Вчора</h3>
          <p>Тікети: <span id="today-tickets">—</span></p>
          <p>Час у грі: <span id="today-time">—</span></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Тиждень</h3>
          <p>Тікети: <span id="week-tickets">—</span></p>
          <p>Час у грі: <span id="week-time">—</span></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Місяць</h3>
          <p>Тікети: <span id="month-tickets">—</span></p>
          <p>Час у грі: <span id="month-time">—</span></p>
        </div>
      </div>

      <div class="bg-white p-4 rounded shadow mb-6">
        <h3 class="font-bold mb-4">Динаміка тікетів та часу за останній місяць</h3>
        <canvas id="statsChart" height="150"></canvas>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-bold mb-2">Детальна статистика по днях:</h3>
        <table class="min-w-full text-left border-collapse">
          <thead>
            <tr>
              <th class="border px-2 py-1">Дата</th>
              <th class="border px-2 py-1">Тікети</th>
              <th class="border px-2 py-1">Час у грі</th>
              <th class="border px-2 py-1">Неактив</th>
            </tr>
          </thead>
          <tbody id="daily-stats-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU'; 
    const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';   

    async function getSheetData(sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
      const res = await axios.get(url);
      return res.data.values;
    }

    function parseDate(str) {
      const [d, m, y] = str.split('.');
      return new Date(`${y}-${m}-${d}T00:00:00`);
    }

    function formatDate(date) {
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function secondsToHHMMSS(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}ч ${m}м` : `${m}м`;
    }

    async function fetchUserStatsByTelegram(telegramUsername) {
      try {
        const ticketsData = await getSheetData('Май_2025_таблица');
        const timeData = await getSheetData('Время_в_игре');

        const ticketsHeaders = ticketsData[0].map(h => h.trim());
        const telegramColIndex = ticketsHeaders.indexOf('Telegram');
        const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

        const userTicketsRow = ticketsData.find(row => (row[telegramColIndex] || '').trim() === telegramUsername);
        if (!userTicketsRow) {
          alert('Користувача не знайдено у таблиці тікетів');
          return;
        }

        const userName = (userTicketsRow[nameColIndex] || '').trim();

        const timeHeaders = timeData[0].map(h => h.trim());
        const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
        const userTimeRow = timeData.find(row => (row[timeNameColIndex] || '').trim() === userName);
        if (!userTimeRow) {
          alert('Користувача не знайдено у таблиці часу');
          return;
        }

        const today = new Date();
        today.setHours(0,0,0,0);

        // Вчора — це вчорашній день відносно сьогоднішнього
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        // Отримуємо колонки з датами в форматі дд.мм.гггг
        const dateCols = ticketsHeaders
          .map((h, i) => ({h: h.trim(), i}))
          .filter(({h}) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

        // Функція для підрахунку тікетів і часу за період
        function sumTicketsAndTime(startDate, endDate) {
          let ticketsSum = 0;
          let timeSecondsSum = 0;

          for (const {h, i} of dateCols) {
            const dt = parseDate(h);
            if (dt >= startDate && dt <= endDate) {
              const ticketVal = parseInt((userTicketsRow[i] || '').trim()) || 0;
              ticketsSum += ticketVal;

              const timeColIndex = timeHeaders.indexOf(h);
              if (timeColIndex >= 0) {
                const timeStr = (userTimeRow[timeColIndex] || '').trim();
                if (timeStr && timeStr !== 'Н') {
                  const [hh, mm, ss] = timeStr.split(':').map(Number);
                  timeSecondsSum += (hh || 0)*3600 + (mm || 0)*60 + (ss || 0);
                }
              }
            }
          }

          return {ticketsSum, timeSecondsSum};
        }

        // Обчислюємо статистику за вчора, тиждень, місяць
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - 6);
        weekStart.setHours(0,0,0,0);

        const monthStart = new Date(today);
        monthStart.setDate(today.getDate() - 29);
        monthStart.setHours(0,0,0,0);

        const yesterdayStats = sumTicketsAndTime(yesterday, yesterday);
        const weekStats = sumTicketsAndTime(weekStart, today);
        const monthStats = sumTicketsAndTime(monthStart, today);

        // Оновлюємо UI
        document.getElementById('today-tickets').innerText = yesterdayStats.ticketsSum;
        document.getElementById('today-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);

        document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
        document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);

        document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
        document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

        // Таблиця детальної статистики
        const tbody = document.getElementById('daily-stats-body');
        tbody.innerHTML = '';

        let inactiveCount = 0;

        // Дані для графіка
        const chartLabels = [];
        const chartTickets = [];
        const chartTimeHours = [];

        dateCols.forEach(({h, i}) => {
          const dt = parseDate(h);
          if (dt >= monthStart && dt <= today) {
            const dayTickets = parseInt((userTicketsRow[i] || '').trim()) || 0;
            const timeColIndex = timeHeaders.indexOf(h);
            let dayTimeStr = 'Н';
            let dayTimeSeconds = 0;
            if (timeColIndex >= 0) {
              dayTimeStr = (userTimeRow[timeColIndex] || 'Н').trim();
              if (dayTimeStr !== 'Н') {
                const [hh, mm, ss] = dayTimeStr.split(':').map(Number);
                dayTimeSeconds = (hh || 0)*3600 + (mm || 0)*60 + (ss || 0);
              }
            }
            if (dayTimeStr === 'Н') inactiveCount++;

            const tr = document.createElement('tr');
            tr.innerHTML = 
              `<td class="border px-2 py-1">${h}</td>
               <td class="border px-2 py-1">${dayTickets}</td>
               <td class="border px-2 py-1">${dayTimeStr}</td>
               <td class="border px-2 py-1">${dayTimeStr === 'Н' ? 'Так' : ''}</td>`;
            tbody.appendChild(tr);

            chartLabels.push(h);
            chartTickets.push(dayTickets);
            chartTimeHours.push((dayTimeSeconds / 3600).toFixed(2));
          }
        });

        // Підсумок неактивних
        const trTotal = document.createElement('tr');
        trTotal.innerHTML = 
          `<td class="border px-2 py-1 font-bold">Всього неактивних</td>
           <td class="border px-2 py-1 font-bold" colspan="3">${inactiveCount}</td>`;
        tbody.appendChild(trTotal);

        // Графік
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (window.statsChartInstance) window.statsChartInstance.destroy();

        window.statsChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: 'Тікети',
                data: chartTickets,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.3)',
                yAxisID: 'yTickets',
                tension: 0.3,
              },
              {
                label: 'Час у грі (години)',
                data: chartTimeHours,
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.3)',
                yAxisID: 'yTime',
                tension: 0.3,
              }
            ],
          },
          options: {
            responsive: true,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            stacked: false,
            scales: {
              yTickets: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Тікети',
                },
                beginAtZero: true,
              },
              yTime: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Години',
                },
                beginAtZero: true,
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });

      } catch (error) {
        console.error('Помилка отримання статистики:', error);
        alert('Помилка отримання статистики, перевірте консоль.');
      }
    }

    function onTelegramAuth(user) {
      const loginSection = document.getElementById('login-section');
      const dashboard = document.getElementById('dashboard');
      loginSection.style.display = 'none';
      dashboard.classList.remove('hidden');

      fetchUserStatsByTelegram(user.username);
    }
  </script>
</body>
</html>
