<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Статистика тікетів</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    
    .animate-float {
      animation: float 4s ease-in-out infinite;
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.6s ease-out forwards;
    }
    
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
    
    .stats-grid {
      perspective: 1000px;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px) rotateX(5deg);
      box-shadow: 0 20px 30px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container {
      background: linear-gradient(145deg, #0a0c12, #0e1018);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .chart-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(25, 119, 253, 0.1) 0%, transparent 70%);
      z-index: 0;
    }
    
    .glow-text {
      text-shadow: 0 0 10px rgba(25, 119, 253, 0.7);
    }
    
    .gradient-border {
      position: relative;
      z-index: 1;
    }
    
    .gradient-border::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #1977FD, #00C2FF);
      border-radius: 14px;
      z-index: -1;
    }
  </style>
</head>
<body class="bg-[#050608] text-[#FFFBEF] font-sans min-h-screen">
  <div class="container mx-auto p-4 max-w-6xl">
    <div class="text-center mb-8 mt-4">
      <h1 class="text-4xl font-bold mb-2 glow-text text-[#1977FD] animate-float">Статистика тікетів</h1>
      <div class="h-1 w-32 bg-gradient-to-r from-[#1977FD] to-[#00C2FF] mx-auto rounded-full"></div>
    </div>
    
    <div id="login-section" class="max-w-md mx-auto bg-[#0a0c12] rounded-2xl p-8 shadow-2xl gradient-border">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-[#1977FD] mb-2">Ласкаво просимо!</h2>
        <p class="text-[#FFFBEF]">Будь ласка, увійдіть через Telegram:</p>
      </div>
      <div class="flex justify-center">
        <script async src="https://telegram.org/js/telegram-widget.js?7"
                data-telegram-login="ticket_tracker_UG_bot" 
                data-size="large"
                data-radius="20"
                data-userpic="false"
                data-request-access="write"
                data-onauth="onTelegramAuth(user)">
        </script>
      </div>
    </div>
    
    <div id="dashboard" class="hidden">
      <div class="text-center mb-10">
        <h1 id="welcome-text" class="text-3xl font-bold text-[#1977FD] glow-text mb-2"></h1>
        <div class="h-1 w-24 bg-gradient-to-r from-[#1977FD] to-[#00C2FF] mx-auto rounded-full mb-6"></div>
      </div>
      
      <h2 class="text-2xl font-bold mb-6 text-[#1977FD] glow-text">Ваша статистика:</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-10 stats-grid">
        <div class="card-hover bg-[#0a0c12] p-6 rounded-xl shadow-xl gradient-border animate-fadeIn delay-1">
          <h3 class="font-bold mb-4 text-xl text-[#1977FD]">За вчора</h3>
          <div class="space-y-2">
            <p class="flex justify-between"><span>Тікети:</span> <span id="yesterday-tickets" class="font-bold">—</span></p>
            <p class="flex justify-between"><span>Час у грі:</span> <span id="yesterday-time" class="font-bold">—</span></p>
          </div>
        </div>
        
        <div class="card-hover bg-[#0a0c12] p-6 rounded-xl shadow-xl gradient-border animate-fadeIn delay-2">
          <h3 class="font-bold mb-4 text-xl text-[#1977FD]">Тиждень</h3>
          <div class="space-y-2">
            <p class="flex justify-between"><span>Тікети:</span> <span id="week-tickets" class="font-bold">—</span></p>
            <p class="flex justify-between"><span>Час у грі:</span> <span id="week-time" class="font-bold">—</span></p>
          </div>
        </div>
        
        <div class="card-hover bg-[#0a0c12] p-6 rounded-xl shadow-xl gradient-border animate-fadeIn delay-3">
          <h3 class="font-bold mb-4 text-xl text-[#1977FD]">Місяць</h3>
          <div class="space-y-2">
            <p class="flex justify-between"><span>Тікети:</span> <span id="month-tickets" class="font-bold">—</span></p>
            <p class="flex justify-between"><span>Час у грі:</span> <span id="month-time" class="font-bold">—</span></p>
          </div>
        </div>
      </div>

      <div class="chart-container p-6 mb-10 animate-fadeIn delay-2">
        <h3 class="font-bold mb-4 text-xl text-[#1977FD] glow-text">Динаміка тікетів та часу за останній місяць</h3>
        <canvas id="statsChart" height="180"></canvas>
      </div>

      <div class="bg-[#0a0c12] rounded-xl shadow-xl p-6 gradient-border animate-fadeIn delay-3">
        <h3 class="font-bold mb-4 text-xl text-[#1977FD] glow-text">Детальна статистика по днях:</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left border-collapse">
            <thead>
              <tr class="bg-[#0e1018]">
                <th class="border border-[#1c1f2b] px-4 py-3 text-[#1977FD]">Дата</th>
                <th class="border border-[#1c1f2b] px-4 py-3 text-[#1977FD]">Тікети</th>
                <th class="border border-[#1c1f2b] px-4 py-3 text-[#1977FD]">Час у грі</th>
                <th class="border border-[#1c1f2b] px-4 py-3 text-[#1977FD]">Неактив</th>
              </tr>
            </thead>
            <tbody id="daily-stats-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU'; 
    const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';   

    async function getSheetData(sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
      const res = await axios.get(url);
      return res.data.values;
    }

    function parseDate(str) {
      const [d, m, y] = str.split('.');
      return new Date(y, m-1, d);
    }

    function formatDate(date) {
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function secondsToHHMMSS(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}г ${m}хв` : `${m}хв`;
    }

    // Получение начала недели (понедельник)
    function getWeekStart(date) {
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(date.setDate(diff));
    }

    // Получение конца недели (воскресенье)
    function getWeekEnd(date) {
      const start = getWeekStart(new Date(date));
      start.setDate(start.getDate() + 6);
      return start;
    }

    // Получение начала месяца
    function getMonthStart(date) {
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    // Получение конца месяца
    function getMonthEnd(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0);
    }

    async function fetchUserStatsByTelegram(telegramUsername) {
      try {
        const ticketsData = await getSheetData('Май_2025_таблица');
        const timeData = await getSheetData('Время_в_игре');

        const ticketsHeaders = ticketsData[0];
        const telegramColIndex = ticketsHeaders.indexOf('Telegram');
        const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');
        const nicknameColIndex = ticketsHeaders.indexOf('Никнейм');

        const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === telegramUsername);
        if (!userTicketsRow) {
          alert('Користувача не знайдено в таблиці тікетів');
          return;
        }

        const userName = userTicketsRow[nameColIndex];
        const userNickname = userTicketsRow[nicknameColIndex] || userName;

        const timeHeaders = timeData[0];
        const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
        const userTimeRow = timeData.find(row => row[timeNameColIndex] === userName);
        if (!userTimeRow) {
          alert('Користувача не знайдено в таблиці часу');
          return;
        }

        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        
        // Периоды для статистики
        const weekStart = getWeekStart(new Date(yesterday));
        const weekEnd = getWeekEnd(new Date(yesterday));
        const monthStart = getMonthStart(new Date(yesterday));
        const monthEnd = getMonthEnd(new Date(yesterday));

        const dateCols = ticketsHeaders
          .map((h, i) => ({ h, i }))
          .filter(({ h }) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

        function sumTicketsAndTime(startDate, endDate) {
          let ticketsSum = 0;
          let timeSecondsSum = 0;

          dateCols.forEach(({ h, i }) => {
            const dt = parseDate(h);
            if (dt >= startDate && dt <= endDate) {
              ticketsSum += parseInt(userTicketsRow[i]) || 0;
              const timeColIndex = timeHeaders.indexOf(h);
              if (timeColIndex >= 0) {
                const timeStr = userTimeRow[timeColIndex];
                if (timeStr && timeStr !== 'Н') {
                  const [hh, mm, ss] = timeStr.split(':').map(Number);
                  timeSecondsSum += hh * 3600 + mm * 60 + ss;
                }
              }
            }
          });

          return { ticketsSum, timeSecondsSum };
        }

        // Статистика за периоды
        const yesterdayStats = sumTicketsAndTime(yesterday, yesterday);
        const weekStats = sumTicketsAndTime(weekStart, weekEnd);
        const monthStats = sumTicketsAndTime(monthStart, monthEnd);

        // Обновление DOM
        document.getElementById('yesterday-tickets').innerText = yesterdayStats.ticketsSum;
        document.getElementById('yesterday-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);
        document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
        document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);
        document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
        document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

        // Детальная статистика по дням
        const tbody = document.getElementById('daily-stats-body');
        tbody.innerHTML = '';
        let inactiveCount = 0;
        const chartLabels = [];
        const chartTickets = [];
        const chartTimeHours = [];

        dateCols.forEach(({ h, i }) => {
          const dt = parseDate(h);
          if (dt >= monthStart && dt <= monthEnd) {
            const dayTickets = parseInt(userTicketsRow[i]) || 0;
            const timeColIndex = timeHeaders.indexOf(h);
            let dayTimeStr = 'Н';
            let dayTimeSeconds = 0;
            if (timeColIndex >= 0) {
              dayTimeStr = userTimeRow[timeColIndex] || 'Н';
              if (dayTimeStr !== 'Н') {
                const [hh, mm, ss] = dayTimeStr.split(':').map(Number);
                dayTimeSeconds = hh * 3600 + mm * 60 + ss;
              }
            }
            if (dayTimeStr === 'Н') inactiveCount++;

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-[#0e1018]';
            tr.innerHTML = `
              <td class="border border-[#1c1f2b] px-4 py-2">${h}</td>
              <td class="border border-[#1c1f2b] px-4 py-2 text-center">${dayTickets}</td>
              <td class="border border-[#1c1f2b] px-4 py-2 text-center">${dayTimeStr}</td>
              <td class="border border-[#1c1f2b] px-4 py-2 text-center">${dayTimeStr === 'Н' ? 'Так' : ''}</td>
            `;
            tbody.appendChild(tr);

            chartLabels.push(h);
            chartTickets.push(dayTickets);
            chartTimeHours.push((dayTimeSeconds / 3600).toFixed(2));
          }
        });

        const trTotal = document.createElement('tr');
        trTotal.className = 'bg-[#0e1018] font-bold';
        trTotal.innerHTML = `
          <td class="border border-[#1c1f2b] px-4 py-2">Усього неактивів</td>
          <td class="border border-[#1c1f2b] px-4 py-2 text-center" colspan="3">${inactiveCount}</td>
        `;
        tbody.appendChild(trTotal);

        // График
        const ctx = document.getElementById('statsChart').getContext('2d');
        if (window.statsChartInstance) window.statsChartInstance.destroy();

        window.statsChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: 'Тікети',
                data: chartTickets,
                borderColor: '#1977FD',
                backgroundColor: 'rgba(25, 119, 253, 0.2)',
                borderWidth: 2,
                pointBackgroundColor: '#1977FD',
                pointBorderColor: '#FFFBEF',
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.3,
                fill: false,
              },
              {
                label: 'Час у грі (години)',
                data: chartTimeHours,
                borderColor: '#00C2FF',
                backgroundColor: 'rgba(0, 194, 255, 0.2)',
                borderWidth: 2,
                pointBackgroundColor: '#00C2FF',
                pointBorderColor: '#FFFBEF',
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.3,
                fill: false,
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                labels: {
                  color: '#FFFBEF',
                  font: {
                    size: 14
                  }
                }
              },
              tooltip: {
                backgroundColor: '#0a0c12',
                titleColor: '#1977FD',
                bodyColor: '#FFFBEF',
                borderColor: '#1977FD',
                borderWidth: 1,
                padding: 12,
                callbacks: {
                  label: ctx => ctx.dataset.label === 'Час у грі (години)'
                    ? `${ctx.parsed.y} год`
                    : `${ctx.parsed.y} тікетів`,
                }
              }
            },
            scales: {
              x: {
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)'
                },
                ticks: {
                  color: '#FFFBEF',
                  maxRotation: 90,
                  minRotation: 45,
                  maxTicksLimit: 15,
                }
              },
              y: {
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)'
                },
                ticks: {
                  color: '#FFFBEF'
                }
              }
            }
          },
        });

      } catch (error) {
        console.error(error);
        alert('Помилка під час завантаження даних з Google Sheets');
      }
    }

    function onTelegramAuth(user) {
      const telegramUsername = '@' + user.username;
      const firstName = user.first_name;

      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      
      // Показываем анимацию
      document.querySelectorAll('.animate-fadeIn').forEach(el => {
        el.style.opacity = 0;
      });
      
      setTimeout(() => {
        document.querySelectorAll('.animate-fadeIn').forEach(el => {
          el.style.opacity = 1;
        });
      }, 10);
      
      // Будем использовать никнейм из таблицы
      // Временно используем имя из Telegram, пока не загрузим данные
      document.getElementById('welcome-text').innerText = `Вітаю, ${firstName}!`;
      
      fetchUserStatsByTelegram(telegramUsername).then(() => {
        // После загрузки данных обновим приветствие
        // Фактическое обновление происходит внутри fetchUserStatsByTelegram
      });
    }
  </script>
</body>
</html>
