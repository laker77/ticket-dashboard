<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Статистика тікетів</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* Стили для адаптивной таблицы */
    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        font-size: 0.875rem;
      }
      th, td {
        padding: 0.25rem 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Ласкаво просимо!</h1>
    <div id="login-section">
      <p class="mb-2">Будь ласка, увійдіть через Telegram:</p>
      <script async src="https://telegram.org/js/telegram-widget.js?7"
              data-telegram-login="ticket_tracker_UG_bot" 
              data-size="large"
              data-userpic="false"
              data-request-access="write"
              data-onauth="onTelegramAuth(user)">
      </script>
    </div>
    <div id="dashboard" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Ваша статистика:</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 stats-grid">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">За вчора</h3>
          <p>Тікети: <span id="yesterday-tickets">—</span></p>
          <p>Час у грі: <span id="yesterday-time">—</span></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Тиждень</h3>
          <p>Тікети: <span id="week-tickets">—</span></p>
          <p>Час у грі: <span id="week-time">—</span></p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Місяць</h3>
          <p>Тікети: <span id="month-tickets">—</span></p>
          <p>Час у грі: <span id="month-time">—</span></p>
        </div>
      </div>

      <div class="bg-white p-4 rounded shadow mb-6">
        <h3 class="font-bold mb-4">Динаміка тікетів та часу за останній місяць</h3>
        <canvas id="statsChart" height="150"></canvas>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-bold mb-2">Детальна статистика по днях:</h3>
        <div class="table-container">
          <table class="min-w-full text-left border-collapse">
            <thead>
              <tr>
                <th class="border px-2 py-1">Дата</th>
                <th class="border px-2 py-1">Тікети</th>
                <th class="border px-2 py-1">Час у грі</th>
                <th class="border px-2 py-1">Неактив</th>
              </tr>
            </thead>
            <tbody id="daily-stats-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU'; 
    const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';   

    async function getSheetData(sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
      const res = await axios.get(url);
      return res.data.values;
    }

    function parseDate(str) {
      const [d, m, y] = str.split('.');
      return new Date(y, m-1, d);
    }

    function formatDate(date) {
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function secondsToHHMMSS(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}г ${m}хв` : `${m}хв`;
    }

    // Функция для получения даты без времени
    function getDateWithoutTime(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    async function fetchUserStatsByTelegram(telegramUsername) {
      try {
        const ticketsData = await getSheetData('Май_2025_таблица');
        const timeData = await getSheetData('Время_в_игре');

        const ticketsHeaders = ticketsData[0];
        const telegramColIndex = ticketsHeaders.indexOf('Telegram');
        const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

        const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === telegramUsername);
        if (!userTicketsRow) {
          alert('Користувача не знайдено в таблиці тікетів');
          return;
        }

        const userName = userTicketsRow[nameColIndex];

        const timeHeaders = timeData[0];
        const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
        const userTimeRow = timeData.find(row => row[timeNameColIndex] === userName);
        if (!userTimeRow) {
          alert('Користувача не знайдено в таблиці часу');
          return;
        }

        const today = getDateWithoutTime(new Date());
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        const dateCols = ticketsHeaders
          .map((h, i) => ({ h, i }))
          .filter(({ h }) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

        function sumTicketsAndTime(startDate, endDate) {
          let ticketsSum = 0;
          let timeSecondsSum = 0;

          dateCols.forEach(({ h, i }) => {
            const dt = parseDate(h);
            if (dt >= startDate && dt <= endDate) {
              ticketsSum += parseInt(userTicketsRow[i]) || 0;
              const timeColIndex = timeHeaders.indexOf(h);
              if (timeColIndex >= 0) {
                const timeStr = userTimeRow[timeColIndex];
                if (timeStr && timeStr !== 'Н') {
                  const [hh, mm, ss] = timeStr.split(':').map(Number);
                  timeSecondsSum += hh * 3600 + mm * 60 + ss;
                }
              }
            }
          });

          return { ticketsSum, timeSecondsSum };
        }

        // Исправление периодов:
        // Вчера: только один день (yesterday)
        const yesterdayStats = sumTicketsAndTime(yesterday, yesterday);
        
        // Неделя: 7 дней назад до вчера
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - 7);
        const weekStats = sumTicketsAndTime(weekStart, yesterday);
        
        // Месяц: 30 дней назад до вчера
        const monthStart = new Date(today);
        monthStart.setDate(today.getDate() - 30);
        const monthStats = sumTicketsAndTime(monthStart, yesterday);

        document.getElementById('yesterday-tickets').innerText = yesterdayStats.ticketsSum;
        document.getElementById('yesterday-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);
        document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
        document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);
        document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
        document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

        const tbody = document.getElementById('daily-stats-body');
        tbody.innerHTML = '';
        let inactiveCount = 0;
        const chartLabels = [];
        const chartTickets = [];
        const chartTimeHours = [];

        dateCols.forEach(({ h, i }) => {
          const dt = parseDate(h);
          // Выводим данные только до вчера включительно
          if (dt >= monthStart && dt <= yesterday) {
            const dayTickets = parseInt(userTicketsRow[i]) || 0;
            const timeColIndex = timeHeaders.indexOf(h);
            let dayTimeStr = 'Н';
            let dayTimeSeconds = 0;
            if (timeColIndex >= 0) {
              dayTimeStr = userTimeRow[timeColIndex] || 'Н';
              if (dayTimeStr !== 'Н') {
                const [hh, mm, ss] = dayTimeStr.split(':').map(Number);
                dayTimeSeconds = hh * 3600 + mm * 60 + ss;
              }
            }
            if (dayTimeStr === 'Н') inactiveCount++;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="border px-2 py-1">${h}</td>
              <td class="border px-2 py-1">${dayTickets}</td>
              <td class="border px-2 py-1">${dayTimeStr}</td>
              <td class="border px-2 py-1">${dayTimeStr === 'Н' ? 'Так' : ''}</td>
            `;
            tbody.appendChild(tr);

            chartLabels.push(h);
            chartTickets.push(dayTickets);
            chartTimeHours.push((dayTimeSeconds / 3600).toFixed(2));
          }
        });

        const trTotal = document.createElement('tr');
        trTotal.innerHTML = `
          <td class="border px-2 py-1 font-bold">Усього неактивів</td>
          <td class="border px-2 py-1 font-bold" colspan="3">${inactiveCount}</td>
        `;
        tbody.appendChild(trTotal);

        const ctx = document.getElementById('statsChart').getContext('2d');
        if (window.statsChartInstance) window.statsChartInstance.destroy();

        window.statsChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: 'Тікети',
                data: chartTickets,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.3)',
                yAxisID: 'yTickets',
                tension: 0.3,
              },
              {
                label: 'Час у грі (години)',
                data: chartTimeHours,
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.3)',
                yAxisID: 'yTime',
                tension: 0.3,
              }
            ],
          },
          options: {
            responsive: true,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            stacked: false,
            scales: {
              yTickets: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Тікети',
                },
                beginAtZero: true,
              },
              yTime: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Час (години)',
                },
                beginAtZero: true,
                grid: {
                  drawOnChartArea: false,
                },
              },
              x: {
                ticks: {
                  maxRotation: 90,
                  minRotation: 45,
                  maxTicksLimit: 15,
                }
              }
            },
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: ctx => ctx.dataset.label === 'Час у грі (години)'
                    ? `${ctx.parsed.y} год`
                    : ctx.parsed.y,
                }
              }
            }
          },
        });

      } catch (error) {
        console.error(error);
        alert('Помилка під час завантаження даних з Google Sheets');
      }
    }

    function onTelegramAuth(user) {
      const telegramUsername = '@' + user.username;
      const firstName = user.first_name;

      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.querySelector('h1').innerText = `Вітаємо, ${firstName}!`;

      fetchUserStatsByTelegram(telegramUsername);
    }
  </script>
</body>
</html>
