<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Статистика тикетов</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Добро пожаловать!</h1>
    <div id="login-section">
      <p class="mb-2">Пожалуйста, войдите через Telegram:</p>
      <script async src="https://telegram.org/js/telegram-widget.js?7"
              data-telegram-login="ticket_tracker_UG_bot" 
              data-size="large"
              data-userpic="false"
              data-request-access="write"
              data-onauth="onTelegramAuth(user)">
      </script>
    </div>
    <div id="dashboard" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Ваша статистика:</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold">Сегодня</h3>
          <p id="today-tickets">—</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold">Неделя</h3>
          <p id="week-tickets">—</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold">Месяц</h3>
          <p id="month-tickets">—</p>
        </div>
      </div>
      <div class="mt-4 bg-white p-4 rounded shadow">
        <h3 class="font-bold">Общее время ответа:</h3>
        <p id="total-time">—</p>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU'; // Вставь сюда ID своей таблицы Google Sheets
    const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';   // Вставь сюда свой Google Sheets API ключ

    async function getSheetData(sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
      const res = await axios.get(url);
      return res.data.values;
    }

    function parseDate(str) {
      // Преобразуем '01.06.2025' -> Date
      const [d, m, y] = str.split('.');
      return new Date(`${y}-${m}-${d}`);
    }

    function formatDate(date) {
      // Форматируем Date в 'DD.MM.YYYY'
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    async function fetchUserStatsByTelegram(telegramUsername) {
      try {
        const ticketsData = await getSheetData('Май_2025_таблица');
        const timeData = await getSheetData('Время_в_игре');

        const ticketsHeaders = ticketsData[0];
        const telegramColIndex = ticketsHeaders.indexOf('Telegram');
        const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

        const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === telegramUsername);
        if (!userTicketsRow) {
          alert('Пользователь не найден в таблице тикетов');
          return;
        }

        const userName = userTicketsRow[nameColIndex];

        const timeHeaders = timeData[0];
        const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
        const userTimeRow = timeData.find(row => row[timeNameColIndex] === userName);
        if (!userTimeRow) {
          alert('Пользователь не найден в таблице времени');
          return;
        }

        const today = new Date();
        const todayStr = formatDate(today);

        // Найдем даты в заголовках таблиц
        const dateCols = ticketsHeaders
          .map((h, i) => ({h, i}))
          .filter(({h}) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

        // Индекс сегодняшнего дня
        const todayColIndex = ticketsHeaders.indexOf(todayStr);

        // Тикеты за сегодня
        const ticketsToday = todayColIndex >= 0 ? parseInt(userTicketsRow[todayColIndex]) || 0 : 0;

        // Тикеты за неделю (последние 7 дней)
        const weekStart = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
        const last7Dates = dateCols.filter(({h}) => {
          const dt = parseDate(h);
          return dt >= weekStart && dt <= today;
        });

        let ticketsWeek = 0;
        last7Dates.forEach(({i}) => {
          ticketsWeek += parseInt(userTicketsRow[i]) || 0;
        });

        // Тикеты за месяц (последние 30 дней)
        const monthStart = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
        const last30Dates = dateCols.filter(({h}) => {
          const dt = parseDate(h);
          return dt >= monthStart && dt <= today;
        });

        let ticketsMonth = 0;
        last30Dates.forEach(({i}) => {
          ticketsMonth += parseInt(userTicketsRow[i]) || 0;
        });

        // Время в игре за месяц (сумма по last30Dates)
        let totalTimeHours = 0;

        last30Dates.forEach(({i}) => {
          const timeStr = userTimeRow[i];
          if (timeStr && timeStr !== 'Н') {
            const [hh, mm, ss] = timeStr.split(':').map(Number);
            totalTimeHours += hh + mm / 60 + ss / 3600;
          }
        });

        // Обновляем UI
        document.getElementById('today-tickets').innerText = ticketsToday;
        document.getElementById('week-tickets').innerText = ticketsWeek;
        document.getElementById('month-tickets').innerText = ticketsMonth;
        document.getElementById('total-time').innerText = totalTimeHours.toFixed(2) + ' ч';

      } catch (error) {
        console.error(error);
        alert('Ошибка при загрузке данных из Google Sheets');
      }
    }

    function onTelegramAuth(user) {
      const telegramUsername = '@' + user.username; // в таблице Telegram с @
      const firstName = user.first_name;

      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.querySelector('h1').innerText = `Здравствуйте, ${firstName}!`;

      fetchUserStatsByTelegram(telegramUsername);
    }
  </script>
</body>
</html>
