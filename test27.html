<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Особистий Кабінет Адміністратора</title>
  <link rel="icon" href="1-17ffebdc.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        font-size: 0.875rem;
      }
      th, td {
        padding: 0.25rem 0.5rem;
      }
      .top-admins-container {
        flex-direction: column;
        align-items: center;
      }
    }
  body {
  background-color: #050608 !important;
  color: #FFFBEF !important;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#login-section {
  background-color: #121824;
  padding: 40px 30px;
  border-radius: 20px;
  max-width: 400px;
  margin: 60px auto;
  box-shadow: 0 0 30px #1977FDAA;
  text-align: center;
  animation: fadeInUp 1.2s ease forwards;
  opacity: 0;
  transform: translateY(30px);
  font-weight: 700;
  font-size: 1.3rem;
}

#login-section p {
  margin-bottom: 25px;
  color: #FFFBEF;
  font-weight: 600;
  font-size: 1.1rem;
}

.telegram-button-wrapper {
  display: inline-block;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 0 15px #1977FD;
  animation: pulse 3s infinite ease-in-out;
}

.bg-white.p-4.rounded.shadow.mb-6 {
  background-color: #121315 !important;
  color: #FFFBEF;
}

.table-container table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 8px;
  overflow: hidden;
  font-size: 0.9rem;
  background-color: #1a1a1a;
  color: #dcdcdc;
}

.table-container thead {
  background-color: #222;
}

.table-container th {
  text-align: left;
  padding: 10px 12px;
  font-weight: 500;
  color: #b0b0b0;
}

.table-container td {
  padding: 10px 12px;
  border-top: 1px solid #2c2c2c;
}

.table-container tbody tr:nth-child(even) {
  background-color: #1e1e1e;
}

.table-container tbody tr:hover {
  background-color: #2a2a2a;
  transition: background-color 0.2s ease;
}

table {
  background-color: #121315;
  color: #FFFBEF;
  border-color: #2a2d38;
}

.grid.grid-cols-1.sm\:grid-cols-3.gap-4.mb-6.stats-grid > div {
  background-color: #121315 !important;
  color: #FFFBEF !important;
  border-radius: 14px;
}

.bg-white.p-4.rounded.shadow {
  background-color: #121315 !important;
  color: #FFFBEF;
  box-shadow: none !important;
  border-radius: 14px;
}

.grid.grid-cols-1.sm\:grid-cols-3.gap-4.mb-6.stats-grid > div h3 {
  color: #1977FD;
}

.script-menu {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.menu-button {
  width: 40px;
  height: 40px;
  background-color: #2c2c2c;
  color: white;
  font-size: 22px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

  .menu-category {
  font-weight: bold;
  margin-top: 10px;
  margin-bottom: 5px;
  padding-left: 10px;
  color: #444;
}

.menu-button:hover {
  background-color: #3c3c3c;
}

.script-list {
  display: flex;
  flex-direction: column;
  background-color: #1e1e1e;
  border-radius: 8px;
  padding: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  max-height: 300px;
  overflow-y: auto;
}

.script-list.hidden {
  display: none !important;
}

.script-item {
  padding: 8px 12px;
  color: #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  font-size: 14px;
  display: block;
  text-decoration: none;
  white-space: nowrap;
}

.script-item:hover {
  background-color: #333;
}
.hidden {
  display: none !important;
}

.script-menu {
  animation: fade-in 0.8s ease-out forwards;
}

h1 {
  font-size: 1.8rem;
  margin-bottom: 1.5rem;
  color: #1977FD;
  text-align: center;
  text-shadow: 0 0 10px rgba(25, 119, 253, 0.5);
}

#logout-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #ff4d4d;
  color: white;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  z-index: 1001;
  transition: background-color 0.3s;
  border: none;
  font-weight: bold;
}

#logout-btn:hover {
  background-color: #e60000;
}

@keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
  animation: fade-in 0.8s ease-out forwards;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 15px #1977FD;
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 35px #1977FD;
    transform: scale(1.1);
  }
}

/* Стили для нового меню суперадминов */
.super-menu-button {
  width: 40px;
  height: 40px;
  background-color: #1a1a1a;
  color: #357cf0;
  font-size: 22px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid #357cf0;
}

.super-menu-button:hover {
  background-color: #333;
  transform: scale(1.05);
}

.super-script-list {
  display: flex;
  flex-direction: column;
  background-color: #1e1e1e;
  border-radius: 8px;
  padding: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  border: 1px solid #357cf0;
  max-height: 300px;
  overflow-y: auto;
}

.super-script-item {
  padding: 8px 12px;
  color: #ffd700;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  font-size: 14px;
  display: block;
  text-decoration: none;
  white-space: nowrap;
}

.super-script-item:hover {
  background-color: #333;
  color: #fff;
}

    .anniversary-banner {
    background: linear-gradient(90deg, #2c3e50, #4a6582);
    color: #ecf0f1;
    text-align: center;
    padding: 12px;
    margin-bottom: 20px;
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    border: 1px solid #34495e;
}

.anniversary-banner p {
    margin: 0;
    font-weight: 500;
    font-size: 1rem;
    letter-spacing: 0.5px;
}
   
/* Обновленные стили для администраторов недели */
.top-admins-section {
  background: #121315;
  border-radius: 16px;
  padding: 25px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  border: 1px solid #2a2a2a;
}

.top-admins-title {
  text-align: center;
  font-size: 1.7rem;
  margin-bottom: 25px;
  color: #e0e0e0;
  font-weight: 600;
  position: relative;
  letter-spacing: 0.5px;
}

.top-admins-title::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 3px;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6);
  border-radius: 3px;
}

.top-admins-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 25px;
  margin-top: 20px;
}

.admin-card {
  background: linear-gradient(145deg, #1a1a1a, #151515);
  border-radius: 12px;
  width: 170px;
  padding: 20px 15px;
  text-align: center;
  position: relative;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  border-top: 1px solid #2a2a2a;
}

.admin-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
  border-top: 1px solid #3b82f6;
}

.admin-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  margin: 0 auto 15px;
  display: block;
  position: relative;
  background: #1f1f1f;
  padding: 5px;
}

/* Стили для рамки аватарки в зависимости от места */
.admin-card.gold .admin-avatar {
  border: 3px solid #d4af37;
  box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
}

.admin-card.silver .admin-avatar {
  border: 3px solid #c0c0c0;
  box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
}

.admin-card.bronze .admin-avatar {
  border: 3px solid #cd7f32;
  box-shadow: 0 0 15px rgba(205, 127, 50, 0.2);
}

.admin-card.normal .admin-avatar {
  border: 3px solid #3b82f6;
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
}

.medal {
  position: absolute;
  top: -12px;
  right: -12px;
  font-size: 2.2rem;
  z-index: 2;
  filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.4));
}

.admin-name {
  font-weight: 600;
  margin-bottom: 5px;
  color: #f0f0f0;
  font-size: 1.05rem;
  letter-spacing: 0.3px;
}

.admin-stats {
  font-size: 0.85rem;
  color: #888;
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.admin-stat-value {
  color: #e0e0e0;
  font-weight: 500;
  font-size: 1.05rem;
}

.week-info {
  text-align: center;
  color: #777;
  font-size: 0.9rem;
  margin-top: 20px;
  font-style: italic;
  position: relative;
  padding-top: 15px;
}

.week-info::before {
  content: "";
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40%;
  height: 1px;
  background: linear-gradient(90deg, transparent, #3b82f6, transparent);
}

/* Стили для места */
.place-badge {
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.9rem;
  z-index: 1;
}

.gold .place-badge {
  background: #d4af37;
  color: #121315;
}

.silver .place-badge {
  background: #c0c0c0;
  color: #121315;
}

.bronze .place-badge {
  background: #cd7f32;
  color: #121315;
}

.normal .place-badge {
  background: #3b82f6;
  color: #f0f0f0;
}

/* Эффект подложки */
.admin-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
}

.gold::before { background: linear-gradient(90deg, #d4af37, #f9d423); }
.silver::before { background: linear-gradient(90deg, #c0c0c0, #e0e0e0); }
.bronze::before { background: linear-gradient(90deg, #cd7f32, #e9a957); }
.normal::before { background: linear-gradient(90deg, #3b82f6, #8b5cf6); }

    /* New styles for access denied page */
    #access-denied-section {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      z-index: 2000;
      text-align: center;
      padding-top: 20%;
    }
    
    .access-denied-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 40px;
      background: rgba(30, 41, 59, 0.9);
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(239, 68, 68, 0.5);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .access-denied-icon {
      font-size: 100px;
      color: #ef4444;
      margin-bottom: 30px;
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.7);
    }
    
    .access-denied-title {
      font-size: 32px;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .access-denied-message {
      font-size: 18px;
      color: #cbd5e1;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .back-to-login-btn {
      display: inline-block;
      background: #ef4444;
      color: white;
      padding: 12px 30px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
    }
    
    .back-to-login-btn:hover {
      background: #dc2626;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.6);
    }

  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <button id="logout-btn" class="hidden">Вийти</button>

  <!-- Access Denied Section -->
  <div id="access-denied-section">
    <div class="access-denied-content">
      <div class="access-denied-icon">🚫</div>
      <h1 class="access-denied-title">ВІДМОВЛЕНО У ДОСТУПІ</h1>
      <p class="access-denied-message">
        Ваш обліковий запис не має доступу до цієї системи.<br>
        Будь ласка, зверніться до суперадміністратора для отримання додаткової інформації.
      </p>
      <button class="back-to-login-btn" onclick="logout()">Повернутися до входу</button>
    </div>
  </div>

  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4" id="welcome-header">Ласкаво просимо!</h1>

    
    <!-- Праздничная плашка -->
    <div id="anniversary-banner" class="anniversary-banner hidden">
      <p>🎉 Сьогодні ми святкуємо 3 річницю проєкту! Не забудь привітати в групі з річницею! 🎉</p>
    </div>
    
    <!-- Секция авторизации -->
    <div id="login-section">
      <p>Будь ласка, увійдіть через Telegram:</p>
      <div class="telegram-button-wrapper">
        <script async src="https://telegram.org/js/telegram-widget.js?7"
                data-telegram-login="ticket_tracker_UG_bot" 
                data-size="large"
                data-userpic="false"
                data-request-access="write"
                data-onauth="onTelegramAuth(user)">
        </script>
      </div>
    </div>
    
    <!-- Контейнер для обоих меню -->
    <div class="script-menu hidden" id="menuContainer">
<!-- Основное меню -->
<div>
  <div class="menu-button" onclick="toggleScripts()">≡</div>
  <div class="script-list hidden" id="scriptList">
    
    <div class="menu-category">Скрипти</div>
    <a href="script1.1.html" class="script-item">Скрипт 1.1</a>
    <a href="script1.2.html" class="script-item">Скрипт 1.2</a>
    <a href="script1.3.html" class="script-item">Скрипт 1.3</a>
    <a href="script1.4.html" class="script-item">Скрипт 1.4</a>
    <a href="script1.5.html" class="script-item">Скрипт 1.5</a>
    <a href="script1.6.html" class="script-item">Скрипт 1.6</a>
    <a href="script1.7.html" class="script-item">Скрипт 1.7</a>

    <div class="menu-category">Інформація</div>
    <a href="team.html" class="script-item">Команда проєкту та до кого звертатися</a>
    <a href="tickets.html" class="script-item">Регламент Відповіді на Тікети</a>
    <a href="commands.html" class="script-item">Команди адміністратора</a>
    <a href="faq.html" class="script-item">Питання та відповіді</a>
     <a href="binder.html" class="script-item">BinderBot</a>

  </div>
</div>

      
      <!-- Меню для суперадминов -->
      <div id="superScriptMenu" class="hidden">
        <div class="super-menu-button" onclick="toggleSuperScripts()">≡</div>
        <div class="super-script-list hidden" id="superScriptList">
          <a href="test.html" class="super-script-item">Статистика Адміністраторів</a>
          <a href="super-script2.html" class="super-script-item">Калькулятор онлайну</a>
          <a href="super-script3.html" class="super-script-item">Контроль складу</a>
        </div>
      </div>
    </div>
    
    <div id="dashboard" class="hidden">
      <!-- Блок администраторов недели -->
      <div id="top-admins-section" class="top-admins-section hidden">
        <h2 class="top-admins-title">🏆 Адміністратори тижня</h2>
        <div class="week-info" id="week-range">Період: 01.05.2023 - 07.05.2023</div>
        <div class="top-admins-container" id="top-admins-container">
          <!-- Карточки администраторов будут добавлены сюда -->
        </div>
      </div>
      
      <!-- Блок для администраторов -->
      <div id="admin-notice" class="hidden bg-[#121315] p-6 rounded-xl mb-6 border border-[#1977FD]">
        <h3 class="text-xl font-bold text-[#1977FD] mb-3">👑 Ви - адміністратор системи</h3>
        <p class="mb-2">Ваш обліковий запис не пов'язаний зі статистикою тікетів.</p>
        <p>Ви можете використовувати всі інструменти адміністрування через меню скриптів.</p>
      </div>
      
      <div id="stats-section">
        <h2 class="text-xl font-semibold mb-2">Ваша статистика:</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 stats-grid">
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-2">За вчора</h3>
            <p>Тікети: <span id="yesterday-tickets">—</span></p>
            <p>Час у грі: <span id="yesterday-time">—</span></p>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-2">Тиждень</h3>
            <p>Тікети: <span id="week-tickets">—</span></p>
            <p>Час у грі: <span id="week-time">—</span></p>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-2">Місяць</h3>
            <p>Тікети: <span id="month-tickets">—</span></p>
            <p>Час у грі: <span id="month-time">—</span></p>
          </div>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
          <h3 class="font-bold mb-4">Динаміка тікетів та часу за останній місяць</h3>
          <canvas id="statsChart" height="150"></canvas>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">Детальна статистика по днях:</h3>
          <div class="table-container">
            <table class="min-w-full text-left border-collapse">
              <thead>
                <tr>
                  <th class="border px-2 py-1">Дата</th>
                  <th class="border px-2 py-1">Тікети</th>
                  <th class="border px-2 py-1">Час у грі</th>
                  <th class="border px-2 py-1">Неактив</th>
                </tr>
              </thead>
              <tbody id="daily-stats-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU'; 
const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';   

// Список администраторов с доступом
const allowedAdmins = [
  '@laker_77',
  '@Hermaeus_Mora_1679',
  '@c10mm',
  '@noxx_uagtaV',
  '@B_m_b1',
  '@zhdanovrostyslav'
];

// Список суперадминов для дополнительного меню
const superAdmins = [
  '@laker_77',
  '@B_m_b1',
  '@Hermaeus_Mora_1679',
  '@c10mm'
];

// Функции управления меню
function toggleScripts() {
  const menu = document.getElementById('scriptList');
  const superMenu = document.getElementById('superScriptList');
  
  if (!superMenu.classList.contains('hidden')) {
    superMenu.classList.add('hidden');
  }
  
  menu.classList.toggle('hidden');
}

function toggleSuperScripts() {
  const menu = document.getElementById('superScriptList');
  const mainMenu = document.getElementById('scriptList');
  
  if (!mainMenu.classList.contains('hidden')) {
    mainMenu.classList.add('hidden');
  }
  
  menu.classList.toggle('hidden');
}

// Закрытие меню при клике вне области
document.addEventListener('click', function(event) {
  const menuContainer = document.getElementById('menuContainer');
  const scriptList = document.getElementById('scriptList');
  const superScriptList = document.getElementById('superScriptList');
  
  if (!event.target.closest('.menu-button') && 
      !event.target.closest('.super-menu-button') &&
      !event.target.closest('.script-list') &&
      !event.target.closest('.super-script-list')) {
    
    if (scriptList && !scriptList.classList.contains('hidden')) {
      scriptList.classList.add('hidden');
    }
    if (superScriptList && !superScriptList.classList.contains('hidden')) {
      superScriptList.classList.add('hidden');
    }
  }
});

// Основные функции работы с данными
async function getSheetData(sheetName) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
  const res = await axios.get(url);
  return res.data.values;
}

function parseDate(str) {
  const [d, m, y] = str.split('.');
  return new Date(y, m-1, d);
}

function formatDate(date) {
  const dd = String(date.getDate()).padStart(2, '0');
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const yyyy = date.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

function secondsToHHMMSS(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  return h > 0 ? `${h}г ${m}хв` : `${m}хв`;
}

function getDateWithoutTime(date) {
  return new Date(date.getFullYear(), date.getMonth(), date.getDate());
}

// Функции работы с периодами
function getPreviousWeekRange() {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
  
  const monday = new Date(now);
  monday.setDate(now.getDate() + diffToMonday - 7);
  monday.setHours(0, 0, 0, 0);
  
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  sunday.setHours(23, 59, 59, 999);
  
  return {
    start: formatDate(monday),
    end: formatDate(sunday),
    startDate: monday,
    endDate: sunday
  };
}

function shouldRefreshTopAdmins() {
  const lastUpdate = localStorage.getItem('topAdminsLastUpdate');
  if (!lastUpdate) return true;
  
  const now = new Date();
  const lastUpdateDate = new Date(parseInt(lastUpdate));
  return (now - lastUpdateDate) > 30 * 60 * 1000; // 30 минут
}

async function autoRefreshData() {
  const weekRange = getPreviousWeekRange();
  const cacheKey = `topAdmins_${weekRange.start}_${weekRange.end}`;
  
  localStorage.removeItem(cacheKey);
  localStorage.removeItem('topAdminsLastUpdate');
  await loadAndRenderTopAdmins();
}

// Функции работы с администраторами
async function getTopAdmins(weekRange) {
  try {
    const [ticketsData, timeData] = await Promise.all([
      getSheetData('Май_2025_таблица'),
      getSheetData('Время_в_игре')
    ]);

    const ticketsHeaders = ticketsData[0];
    const timeHeaders = timeData[0];
    const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');
    const telegramColIndex = ticketsHeaders.indexOf('Telegram');

    const admins = [];

    ticketsData.slice(1).forEach(row => {
      const name = row[nameColIndex];
      const telegram = row[telegramColIndex];
      
      if (!name || !telegram) return;

      let ticketsSum = 0;
      let timeSecondsSum = 0;

      ticketsHeaders.forEach((header, index) => {
        if (/^\d{2}\.\d{2}\.\d{4}$/.test(header)) {
          const date = parseDate(header);
          if (date >= weekRange.startDate && date <= weekRange.endDate) {
            ticketsSum += parseInt(row[index]) || 0;
            
            const timeRow = timeData.find(r => r[0] === name);
            if (timeRow) {
              const timeColIndex = timeHeaders.indexOf(header);
              if (timeColIndex >= 0) {
                const timeStr = timeRow[timeColIndex];
                if (timeStr && timeStr !== 'Н') {
                  const [hh, mm, ss] = timeStr.split(':').map(Number);
                  timeSecondsSum += hh * 3600 + mm * 60 + ss;
                }
              }
            }
          }
        }
      });

      admins.push({
        name,
        telegram,
        tickets: ticketsSum,
        time: timeSecondsSum,
        timeFormatted: secondsToHHMMSS(timeSecondsSum)
      });
    });

    admins.sort((a, b) => {
      if (b.tickets !== a.tickets) return b.tickets - a.tickets;
      return b.time - a.time;
    });

    return admins.slice(0, 5);
  } catch (error) {
    console.error('Помилка при завантаженні топу адміністраторів:', error);
    return [];
  }
}

function renderTopAdmins(admins, weekRange) {
  const container = document.getElementById('top-admins-container');
  container.innerHTML = '';
  
  document.getElementById('week-range').textContent = 
    `Період: ${weekRange.start} - ${weekRange.end}`;
  
  admins.forEach((admin, index) => {
    const card = document.createElement('div');
    card.className = 'admin-card';
    
    let medalClass = 'normal';
    let medal = '';
    
    if (index === 0) {
      medalClass = 'gold';
      medal = '🥇';
    } else if (index === 1) {
      medalClass = 'silver';
      medal = '🥈';
    } else if (index === 2) {
      medalClass = 'bronze';
      medal = '🥉';
    }
    
    card.innerHTML = `
      <div class="${medalClass} medal">${medal}</div>
      <img src="https://t.me/i/userpic/320/${admin.telegram.replace('@', '')}.jpg" 
           alt="${admin.name}" 
           class="admin-avatar ${medalClass}"
           onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(admin.name)}&background=1977FD&color=fff'">
      <div class="admin-name">${admin.name}</div>
      <div class="admin-stats">
        <div>Тікети: <span class="admin-stat-value">${admin.tickets}</span></div>
        <div>Час у грі: <span class="admin-stat-value">${admin.timeFormatted}</span></div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

async function loadAndRenderTopAdmins() {
  const weekRange = getPreviousWeekRange();
  const cacheKey = `topAdmins_${weekRange.start}_${weekRange.end}`;
  const cachedData = localStorage.getItem(cacheKey);
  
  if (cachedData && !shouldRefreshTopAdmins()) {
    const { admins } = JSON.parse(cachedData);
    renderTopAdmins(admins, weekRange);
    return;
  }
  
  const admins = await getTopAdmins(weekRange);
  localStorage.setItem(cacheKey, JSON.stringify({ admins }));
  localStorage.setItem('topAdminsLastUpdate', Date.now());
  renderTopAdmins(admins, weekRange);
}

// Функции работы со статистикой пользователя
async function fetchUserStatsByTelegram(telegramUsername) {
  try {
    const ticketsData = await getSheetData('Май_2025_таблица');
    const timeData = await getSheetData('Время_в_игре');

    const ticketsHeaders = ticketsData[0];
    const telegramColIndex = ticketsHeaders.indexOf('Telegram');
    const nameColIndex = ticketsHeaders.indexOf('Имя сотрудника');

    const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === telegramUsername);
    if (!userTicketsRow) {
      alert('Користувача не знайдено в таблиці тікетів');
      return;
    }

    const userName = userTicketsRow[nameColIndex];

    const timeHeaders = timeData[0];
    const timeNameColIndex = timeHeaders.indexOf('Имя сотрудника');
    const userTimeRow = timeData.find(row => row[timeNameColIndex] === userName);
    if (!userTimeRow) {
      alert('Користувача не знайдено в таблиці часу');
      return;
    }

    const today = getDateWithoutTime(new Date());
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    const dateCols = ticketsHeaders
      .map((h, i) => ({ h, i }))
      .filter(({ h }) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

function sumTicketsAndTime(startDate, endDate) {
      let ticketsSum = 0;
      let timeSecondsSum = 0;

      dateCols.forEach(({ h, i }) => {
        const dt = parseDate(h);
        if (dt >= startDate && dt <= endDate) {
          ticketsSum += parseInt(userTicketsRow[i]) || 0;
          const timeColIndex = timeHeaders.indexOf(h);
          if (timeColIndex >= 0) {
            const timeStr = userTimeRow[timeColIndex];
            if (timeStr && timeStr !== 'Н') {
              const [hh, mm, ss] = timeStr.split(':').map(Number);
              timeSecondsSum += hh * 3600 + mm * 60 + ss;
            }
          }
        }
      });

      return { ticketsSum, timeSecondsSum };
    }

    const yesterdayStats = sumTicketsAndTime(yesterday, yesterday);
    
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - 7);
    const weekStats = sumTicketsAndTime(weekStart, yesterday);
    
    const monthStart = new Date(today);
    monthStart.setDate(1);
    const monthStats = sumTicketsAndTime(monthStart, yesterday);

    const allUsers = ticketsData.slice(1).map(row => {
      const name = row[nameColIndex];
      const userTelegram = row[telegramColIndex];

      let totalTickets = 0;
      let totalSeconds = 0;

      dateCols.forEach(({ h, i }) => {
        const dt = parseDate(h);
        if (dt >= monthStart && dt <= yesterday) {
          totalTickets += parseInt(row[i]) || 0;
          const tIndex = timeHeaders.indexOf(h);
          const timeRow = timeData.find(r => r[timeNameColIndex] === name);
          if (timeRow && tIndex >= 0) {
            const timeStr = timeRow[tIndex];
            if (timeStr && timeStr !== 'Н') {
              const [hh, mm, ss] = timeStr.split(':').map(Number);
              totalSeconds += hh * 3600 + mm * 60 + ss;
            }
          }
        }
      });

      return { name, telegram: userTelegram, totalTickets, totalSeconds };
    });

    allUsers.sort((a, b) => {
      if (b.totalTickets !== a.totalTickets)
        return b.totalTickets - a.totalTickets;
      return b.totalSeconds - a.totalSeconds;
    });

    const userIndex = allUsers.findIndex(u => u.telegram === telegramUsername);
    if (userIndex !== -1) {
      const place = userIndex + 1;
      //document.getElementById('current-rank').innerText = `${place}`;
    }

    document.getElementById('yesterday-tickets').innerText = yesterdayStats.ticketsSum;
    document.getElementById('yesterday-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);
    document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
    document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);
    document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
    document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

    const tbody = document.getElementById('daily-stats-body');
    tbody.innerHTML = '';
    let inactiveCount = 0;
    const chartLabels = [];
    const chartTickets = [];
    const chartTimeHours = [];

    dateCols.forEach(({ h, i }) => {
      const dt = parseDate(h);
      if (dt >= monthStart && dt <= yesterday) {
        const dayTickets = parseInt(userTicketsRow[i]) || 0;
        const timeColIndex = timeHeaders.indexOf(h);
        let dayTimeStr = 'Н';
        let dayTimeSeconds = 0;
        if (timeColIndex >= 0) {
          dayTimeStr = userTimeRow[timeColIndex] || 'Н';
          if (dayTimeStr !== 'Н') {
            const [hh, mm, ss] = dayTimeStr.split(':').map(Number);
            dayTimeSeconds = hh * 3600 + mm * 60 + ss;
          }
        }
        if (dayTimeStr === 'Н') inactiveCount++;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-2 py-1">${h}</td>
          <td class="border px-2 py-1">${dayTickets}</td>
          <td class="border px-2 py-1">${dayTimeStr}</td>
          <td class="border px-2 py-1">${dayTimeStr === 'Н' ? 'Так' : ''}</td>
        `;
        tbody.appendChild(tr);

        chartLabels.push(h);
        chartTickets.push(dayTickets);
        chartTimeHours.push((dayTimeSeconds / 3600).toFixed(2));
      }
    });

    const trTotal = document.createElement('tr');
    trTotal.innerHTML = `
      <td class="border px-2 py-1 font-bold">Усього неактивів</td>
      <td class="border px-2 py-1 font-bold" colspan="3">${inactiveCount}</td>
    `;
    tbody.appendChild(trTotal);

    const ctx = document.getElementById('statsChart').getContext('2d');
    if (window.statsChartInstance) window.statsChartInstance.destroy();

    window.statsChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [
          {
            label: 'Тікети',
            data: chartTickets,
            borderColor: 'rgba(59, 130, 246, 1)',
            backgroundColor: 'rgba(59, 130, 246, 0.3)',
            yAxisID: 'yTickets',
            tension: 0.3,
          },
          {
            label: 'Час у грі (години)',
            data: chartTimeHours,
            borderColor: 'rgba(16, 185, 129, 1)',
            backgroundColor: 'rgba(16, 185, 129, 0.3)',
            yAxisID: 'yTime',
            tension: 0.3,
          }
        ],
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        stacked: false,
        scales: {
          yTickets: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Тікети',
            },
            beginAtZero: true,
          },
          yTime: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Час (години)',
            },
            beginAtZero: true,
            grid: {
              drawOnChartArea: false,
            },
          },
          x: {
            ticks: {
              maxRotation: 90,
              minRotation: 45,
              maxTicksLimit: 15,
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: ctx => ctx.dataset.label === 'Час у грі (години)'
                ? `${ctx.parsed.y} год`
                : ctx.parsed.y,
            }
          }
        }
      },
    });

  } catch (error) {
    console.error(error);
    alert('Помилка під час завантаження даних з Google Sheets');
  }
}

// Функции аутентификации и управления интерфейсом
function showAccessDenied() {
  document.getElementById('access-denied-section').classList.remove('hidden');
  document.getElementById('login-section').classList.add('hidden');
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('menuContainer').classList.add('hidden');
  document.getElementById('logout-btn').classList.add('hidden');
}

async function onTelegramAuth(user) {
  const telegramUsername = '@' + user.username;
  
  if (allowedAdmins.includes(telegramUsername)) {
    const userData = {
      username: telegramUsername,
      nickname: user.first_name || user.username,
      isAdmin: true
    };
    localStorage.setItem('tg_auth', JSON.stringify(userData));
    await showDashboard(userData.nickname, telegramUsername, true);
    return;
  }

  try {
    const ticketsData = await getSheetData('Май_2025_таблица');
    const ticketsHeaders = ticketsData[0];
    const telegramColIndex = ticketsHeaders.indexOf('Telegram');
    
    const userTicketsRow = ticketsData.find(row => 
      row[telegramColIndex]?.trim().toLowerCase() === telegramUsername.toLowerCase()
    );
    
    if (userTicketsRow) {
      const userData = {
        username: telegramUsername,
        nickname: userTicketsRow[0],
        isAdmin: false
      };
      localStorage.setItem('tg_auth', JSON.stringify(userData));
      await showDashboard(userData.nickname, telegramUsername, false);
    } else {
      localStorage.removeItem('tg_auth');
      showAccessDenied();
    }
  } catch (error) {
    console.error(error);
    showAccessDenied();
  }
}

async function showDashboard(nickname, telegramUsername, isAdmin) {
  // Проверка доступа для неадминистраторов
  if (!isAdmin) {
    try {
      const ticketsData = await getSheetData('Май_2025_таблица');
      const ticketsHeaders = ticketsData[0];
      const telegramColIndex = ticketsHeaders.indexOf('Telegram');
      
      const userExists = ticketsData.some(row => 
        row[telegramColIndex]?.trim().toLowerCase() === telegramUsername.toLowerCase()
      );
      
      if (!userExists) {
        showAccessDenied();
        return;
      }
    } catch (error) {
      console.error('Помилка перевірки доступу:', error);
      showAccessDenied();
      return;
    }
  }

  // Обновление интерфейса
  document.getElementById('login-section').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('menuContainer').classList.remove('hidden');
  document.getElementById('logout-btn').classList.remove('hidden');
  document.getElementById('access-denied-section').classList.add('hidden');
  document.querySelector('h1').innerText = `Вітаємо, ${nickname}!`;
  
  // Управление супер-меню
  if (superAdmins.includes(telegramUsername)) {
    document.getElementById('superScriptMenu').classList.remove('hidden');
  } else {
    document.getElementById('superScriptMenu').classList.add('hidden');
  }
  
  // Загрузка данных
  document.getElementById('top-admins-section').classList.remove('hidden');
  loadAndRenderTopAdmins();
  
  if (isAdmin) {
    document.getElementById('admin-notice').classList.remove('hidden');
    document.getElementById('stats-section').classList.add('hidden');
    document.getElementById('contest-rank').classList.add('hidden');
  } else {
    document.getElementById('admin-notice').classList.add('hidden');
    document.getElementById('stats-section').classList.remove('hidden');
   // document.getElementById('contest-rank').classList.remove('hidden');
    fetchUserStatsByTelegram(telegramUsername);
  }
}

function showLoginForm() {
  document.getElementById('login-section').classList.remove('hidden');
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('menuContainer').classList.add('hidden');
  document.getElementById('logout-btn').classList.add('hidden');
  document.getElementById('access-denied-section').classList.add('hidden');
  document.querySelector('h1').innerText = 'Ласкаво просимо!';
  document.getElementById('top-admins-section').classList.add('hidden');
}

function logout() {
  localStorage.removeItem('tg_auth');
  showLoginForm();
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('logout-btn').addEventListener('click', logout);
  
  const savedAuth = localStorage.getItem('tg_auth');
  if (savedAuth) {
    try {
      const userData = JSON.parse(savedAuth);
      showDashboard(userData.nickname, userData.username, userData.isAdmin || false);
    } catch (e) {
      localStorage.removeItem('tg_auth');
      showLoginForm();
    }
  } else {
    showLoginForm();
  }
  
  // Периодическое обновление данных
  setInterval(() => {
    if (shouldRefreshTopAdmins()) {
      autoRefreshData();
    }
  }, 5 * 60 * 1000);
  
  // Первоначальная загрузка данных
  autoRefreshData();
});
  </script>
</body>
</html>
