<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Å–æ–±–∏—Å—Ç–∏–π –ö–∞–±—ñ–Ω–µ—Ç –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  <link rel="icon" href="1-17ffebdc.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #050608;
      color: #FFFBEF;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #login-section {
      background-color: #121824;
      padding: 40px 30px;
      border-radius: 20px;
      max-width: 400px;
      margin: 60px auto;
      box-shadow: 0 0 30px #1977FDAA;
      text-align: center;
    }

    #login-section p {
      margin-bottom: 25px;
      color: #FFFBEF;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .telegram-button-wrapper {
      display: inline-block;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 0 15px #1977FD;
    }

    .bg-white.p-4.rounded.shadow.mb-6 {
      background-color: #121315;
      color: #FFFBEF;
    }

    .table-container table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      background-color: #1a1a1a;
      color: #dcdcdc;
    }

    .table-container thead {
      background-color: #222;
    }

    .table-container th {
      text-align: left;
      padding: 10px 12px;
      font-weight: 500;
      color: #b0b0b0;
    }

    .table-container td {
      padding: 10px 12px;
      border-top: 1px solid #2c2c2c;
    }

    .table-container tbody tr:nth-child(even) {
      background-color: #1e1e1e;
    }

    .table-container tbody tr:hover {
      background-color: #2a2a2a;
    }

    table {
      background-color: #121315;
      color: #FFFBEF;
    }

    .stats-grid > div {
      background-color: #121315;
      color: #FFFBEF;
      border-radius: 14px;
    }

    .bg-white.p-4.rounded.shadow {
      background-color: #121315;
      color: #FFFBEF;
    }

    .stats-grid > div h3 {
      color: #1977FD;
    }

    .script-menu {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .menu-button {
      width: 40px;
      height: 40px;
      background-color: #2c2c2c;
      color: white;
      font-size: 22px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .script-list {
      display: flex;
      flex-direction: column;
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .hidden {
      display: none;
    }

    .script-item {
      padding: 8px 12px;
      color: #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: block;
      text-decoration: none;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      color: #1977FD;
      text-align: center;
    }

    #logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #ff4d4d;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1001;
      border: none;
      font-weight: bold;
    }

    .anniversary-banner {
      background: linear-gradient(90deg, #2c3e50, #4a6582);
      color: #ecf0f1;
      text-align: center;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 4px;
      border: 1px solid #34495e;
    }
    
    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        font-size: 0.875rem;
      }
      th, td {
        padding: 0.25rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <button id="logout-btn" class="hidden">–í–∏–π—Ç–∏</button>

  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4" id="welcome-header">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h1>
    
    <div id="anniversary-banner" class="anniversary-banner hidden">
      <p>üéâ –°—å–æ–≥–æ–¥–Ω—ñ –º–∏ —Å–≤—è—Ç–∫—É—î–º–æ 3 —Ä—ñ—á–Ω–∏—Ü—é –ø—Ä–æ—î–∫—Ç—É! –ù–µ –∑–∞–±—É–¥—å –ø—Ä–∏–≤—ñ—Ç–∞—Ç–∏ –≤ –≥—Ä—É–ø—ñ –∑ —Ä—ñ—á–Ω–∏—Ü–µ—é! üéâ</p>
    </div>
    
    <div id="login-section">
      <p>–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Telegram:</p>
      <div class="telegram-button-wrapper">
        <script async src="https://telegram.org/js/telegram-widget.js?7"
                data-telegram-login="ticket_tracker_UG_bot" 
                data-size="large"
                data-userpic="false"
                data-request-access="write"
                data-onauth="onTelegramAuth(user)">
        </script>
      </div>
    </div>
    
    <div class="script-menu hidden" id="menuContainer">
      <div>
        <div class="menu-button" onclick="toggleScripts()">‚â°</div>
        <div class="script-list hidden" id="scriptList">
          <a href="script1.1.html" class="script-item">–°–∫—Ä–∏–ø—Ç 1.1</a>
          <a href="script1.2.html" class="script-item">–°–∫—Ä–∏–ø—Ç 1.2</a>
          <a href="script1.3.html" class="script-item">–°–∫—Ä–∏–ø—Ç 1.3</a>
          <a href="script1.4.html" class="script-item">–°–∫—Ä–∏–ø—Ç 1.4</a>
          <a href="script1.5.html" class="script-item">–°–∫—Ä–∏–ø—Ç 1.5</a>
          <a href="script1.6.html" class="script-item">–°–∫—Ä–∏–ø—Ç 1.6</a>
          <a href="tickets.html" class="script-item">–†–µ–≥–ª–∞–º–µ–Ω—Ç –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –¢—ñ–∫–µ—Ç–∏</a>
          <a href="commands.html" class="script-item">–ö–æ–º–∞–Ω–¥–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>
        </div>
      </div>
    </div>
    
    <div id="dashboard" class="hidden">
      <div id="admin-notice" class="hidden bg-[#121315] p-6 rounded-xl mb-6 border border-[#1977FD]">
        <h3 class="text-xl font-bold text-[#1977FD] mb-3">üëë –í–∏ - –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º–∏</h3>
        <p>–í–∞—à –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –Ω–µ –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é —Ç—ñ–∫–µ—Ç—ñ–≤.</p>
      </div>
      
      <div id="stats-section">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 stats-grid">
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-2">–ó–∞ –≤—á–æ—Ä–∞</h3>
            <p>–¢—ñ–∫–µ—Ç–∏: <span id="yesterday-tickets">‚Äî</span></p>
            <p>–ß–∞—Å —É –≥—Ä—ñ: <span id="yesterday-time">‚Äî</span></p>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-2">–¢–∏–∂–¥–µ–Ω—å</h3>
            <p>–¢—ñ–∫–µ—Ç–∏: <span id="week-tickets">‚Äî</span></p>
            <p>–ß–∞—Å —É –≥—Ä—ñ: <span id="week-time">‚Äî</span></p>
          </div>
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-bold mb-2">–ú—ñ—Å—è—Ü—å</h3>
            <p>–¢—ñ–∫–µ—Ç–∏: <span id="month-tickets">‚Äî</span></p>
            <p>–ß–∞—Å —É –≥—Ä—ñ: <span id="month-time">‚Äî</span></p>
          </div>
        </div>

        <div id="contest-rank" class="bg-[#121315] text-white p-4 rounded-xl shadow mb-6 border border-[#1977FD]">
          <h3 class="text-xl font-bold text-[#1977FD] mb-2">üéâ –ö–æ–Ω–∫—É—Ä—Å "–ö—Ä–∞—â–∏–π –∞–¥–º—ñ–Ω"</h3>
          <p class="mb-2">–¢–∏ –∑–∞—Ä–∞–∑ –Ω–∞ <span id="current-rank" class="font-semibold text-yellow-300">‚Ä¶</span> –º—ñ—Å—Ü—ñ —Å–µ—Ä–µ–¥ —É—Å—ñ—î—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó!</p>
        </div>

        <div class="bg-white p-4 rounded shadow mb-6">
          <h3 class="font-bold mb-4">–î–∏–Ω–∞–º—ñ–∫–∞ —Ç—ñ–∫–µ—Ç—ñ–≤ —Ç–∞ —á–∞—Å—É –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å</h3>
          <canvas id="statsChart" height="150"></canvas>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <h3 class="font-bold mb-2">–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è—Ö:</h3>
          <div class="table-container">
            <table class="min-w-full text-left border-collapse">
              <thead>
                <tr>
                  <th class="border px-2 py-1">–î–∞—Ç–∞</th>
                  <th class="border px-2 py-1">–¢—ñ–∫–µ—Ç–∏</th>
                  <th class="border px-2 py-1">–ß–∞—Å —É –≥—Ä—ñ</th>
                  <th class="border px-2 py-1">–ù–µ–∞–∫—Ç–∏–≤</th>
                </tr>
              </thead>
              <tbody id="daily-stats-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1fobxr4QwD8CLYFaTh2WXNbGwqQ2mWEuQDPkqDzvzkoU';
    const API_KEY = 'AIzaSyB3NNELU9ok5mkbHQnBEoOfRtNtPb-y5LU';
    
    const allowedAdmins = ['@laker_77', '@liquid_ug', '@Hermaeus_Mora_1679', '@c10mm', '@noxx_uagtaV', '@zhdanovrostyslav'];

    function toggleScripts() {
      const menu = document.getElementById('scriptList');
      menu.classList.toggle('hidden');
    }

    async function getSheetData(sheetName) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
      const res = await axios.get(url);
      return res.data.values;
    }

    function parseDate(str) {
      const [d, m, y] = str.split('.');
      return new Date(y, m-1, d);
    }

    function secondsToHHMMSS(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}–≥ ${m}—Ö–≤` : `${m}—Ö–≤`;
    }

    function getDateWithoutTime(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    async function fetchUserStatsByTelegram(telegramUsername) {
      try {
        const [ticketsData, timeData] = await Promise.all([
          getSheetData('–ú–∞–π_2025_—Ç–∞–±–ª–∏—Ü–∞'),
          getSheetData('–í—Ä–µ–º—è_–≤_–∏–≥—Ä–µ')
        ]);

        const ticketsHeaders = ticketsData[0];
        const telegramColIndex = ticketsHeaders.indexOf('Telegram');
        const nameColIndex = ticketsHeaders.indexOf('–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');

        const userTicketsRow = ticketsData.find(row => row[telegramColIndex] === telegramUsername);
        if (!userTicketsRow) {
          alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
          return;
        }

        const userName = userTicketsRow[nameColIndex];
        const timeHeaders = timeData[0];
        const timeNameColIndex = timeHeaders.indexOf('–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
        const userTimeRow = timeData.find(row => row[timeNameColIndex] === userName);
        if (!userTimeRow) {
          alert('–î–∞–Ω—ñ —á–∞—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
          return;
        }

        const today = getDateWithoutTime(new Date());
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        const dateCols = ticketsHeaders
          .map((h, i) => ({ h, i }))
          .filter(({ h }) => /^\d{2}\.\d{2}\.\d{4}$/.test(h));

        function sumTicketsAndTime(startDate, endDate) {
          let ticketsSum = 0;
          let timeSecondsSum = 0;

          for (const { h, i } of dateCols) {
            const dt = parseDate(h);
            if (dt < startDate || dt > endDate) continue;
            
            ticketsSum += parseInt(userTicketsRow[i]) || 0;
            
            const timeColIndex = timeHeaders.indexOf(h);
            if (timeColIndex < 0) continue;
            
            const timeStr = userTimeRow[timeColIndex];
            if (!timeStr || timeStr === '–ù') continue;
            
            const [hh, mm, ss] = timeStr.split(':').map(Number);
            timeSecondsSum += hh * 3600 + mm * 60 + ss;
          }

          return { ticketsSum, timeSecondsSum };
        }

        const yesterdayStats = sumTicketsAndTime(yesterday, yesterday);
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - 7);
        const weekStats = sumTicketsAndTime(weekStart, yesterday);
        const monthStart = new Date(today);
        monthStart.setDate(today.getDate() - 30);
        const monthStats = sumTicketsAndTime(monthStart, yesterday);

        document.getElementById('yesterday-tickets').innerText = yesterdayStats.ticketsSum;
        document.getElementById('yesterday-time').innerText = secondsToHHMMSS(yesterdayStats.timeSecondsSum);
        document.getElementById('week-tickets').innerText = weekStats.ticketsSum;
        document.getElementById('week-time').innerText = secondsToHHMMSS(weekStats.timeSecondsSum);
        document.getElementById('month-tickets').innerText = monthStats.ticketsSum;
        document.getElementById('month-time').innerText = secondsToHHMMSS(monthStats.timeSecondsSum);

        const tbody = document.getElementById('daily-stats-body');
        tbody.innerHTML = '';
        let inactiveCount = 0;
        const chartLabels = [];
        const chartTickets = [];
        const chartTimeHours = [];

        for (const { h, i } of dateCols) {
          const dt = parseDate(h);
          if (dt < monthStart || dt > yesterday) continue;
          
          const dayTickets = parseInt(userTicketsRow[i]) || 0;
          const timeColIndex = timeHeaders.indexOf(h);
          let dayTimeStr = '–ù';
          let dayTimeSeconds = 0;
          
          if (timeColIndex >= 0) {
            dayTimeStr = userTimeRow[timeColIndex] || '–ù';
            if (dayTimeStr !== '–ù') {
              const [hh, mm, ss] = dayTimeStr.split(':').map(Number);
              dayTimeSeconds = hh * 3600 + mm * 60 + ss;
            }
          }
          
          if (dayTimeStr === '–ù') inactiveCount++;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border px-2 py-1">${h}</td>
            <td class="border px-2 py-1">${dayTickets}</td>
            <td class="border px-2 py-1">${dayTimeStr}</td>
            <td class="border px-2 py-1">${dayTimeStr === '–ù' ? '–¢–∞–∫' : ''}</td>
          `;
          tbody.appendChild(tr);

          chartLabels.push(h);
          chartTickets.push(dayTickets);
          chartTimeHours.push((dayTimeSeconds / 3600).toFixed(2));
        }

        const trTotal = document.createElement('tr');
        trTotal.innerHTML = `
          <td class="border px-2 py-1 font-bold">–£—Å—å–æ–≥–æ –Ω–µ–∞–∫—Ç–∏–≤—ñ–≤</td>
          <td class="border px-2 py-1 font-bold" colspan="3">${inactiveCount}</td>
        `;
        tbody.appendChild(trTotal);

        const ctx = document.getElementById('statsChart').getContext('2d');
        if (window.statsChartInstance) window.statsChartInstance.destroy();

        window.statsChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: '–¢—ñ–∫–µ—Ç–∏',
                data: chartTickets,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.3)',
                yAxisID: 'yTickets',
                tension: 0.3,
              },
              {
                label: '–ß–∞—Å —É –≥—Ä—ñ (–≥–æ–¥–∏–Ω–∏)',
                data: chartTimeHours,
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.3)',
                yAxisID: 'yTime',
                tension: 0.3,
              }
            ],
          },
          options: {
            responsive: true,
            scales: {
              yTickets: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: '–¢—ñ–∫–µ—Ç–∏' },
                beginAtZero: true,
              },
              yTime: {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: '–ß–∞—Å (–≥–æ–¥–∏–Ω–∏)' },
                beginAtZero: true,
                grid: { drawOnChartArea: false },
              },
              x: {
                ticks: {
                  maxRotation: 90,
                  minRotation: 45,
                  maxTicksLimit: 15,
                }
              }
            }
          },
        });

      } catch (error) {
        console.error(error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
      }
    }

    async function onTelegramAuth(user) {
      const telegramUsername = '@' + user.username;
      
      if (allowedAdmins.includes(telegramUsername)) {
        localStorage.setItem('tg_auth', JSON.stringify({
          username: telegramUsername,
          nickname: user.first_name || user.username,
          isAdmin: true
        }));
        showDashboard(true);
        return;
      }

      try {
        const ticketsData = await getSheetData('–ú–∞–π_2025_—Ç–∞–±–ª–∏—Ü–∞');
        const ticketsHeaders = ticketsData[0];
        const telegramColIndex = ticketsHeaders.indexOf('Telegram');
        
        const userTicketsRow = ticketsData.find(row => 
          row[telegramColIndex]?.trim().toLowerCase() === telegramUsername.toLowerCase()
        );
        
        if (userTicketsRow) {
          localStorage.setItem('tg_auth', JSON.stringify({
            username: telegramUsername,
            nickname: userTicketsRow[0],
            isAdmin: false
          }));
          showDashboard(false);
        } else {
          localStorage.removeItem('tg_auth');
          alert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ');
          showLoginForm();
        }
      } catch (error) {
        console.error(error);
        alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
        showLoginForm();
      }
    }

    function showDashboard(isAdmin) {
      const userData = JSON.parse(localStorage.getItem('tg_auth'));
      
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('menuContainer').classList.remove('hidden');
      document.getElementById('logout-btn').classList.remove('hidden');
      document.getElementById('welcome-header').innerText = `–í—ñ—Ç–∞—î–º–æ, ${userData.nickname}!`;
      
      if (isAdmin) {
        document.getElementById('admin-notice').classList.remove('hidden');
        document.getElementById('stats-section').classList.add('hidden');
        document.getElementById('contest-rank').classList.add('hidden');
      } else {
        document.getElementById('admin-notice').classList.add('hidden');
        document.getElementById('stats-section').classList.remove('hidden');
        document.getElementById('contest-rank').classList.remove('hidden');
        fetchUserStatsByTelegram(userData.username);
      }
      
      // –ü–æ–∫–∞–∑ –±–∞–Ω–Ω–µ—Ä–∞ –≤ –¥–µ–Ω—å –≥–æ–¥–æ–≤—â–∏–Ω—ã
      const now = new Date();
      if (now.getMonth() === 5 && now.getDate() === 24) {
        document.getElementById('anniversary-banner').classList.remove('hidden');
      }
    }

    function showLoginForm() {
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('menuContainer').classList.add('hidden');
      document.getElementById('logout-btn').classList.add('hidden');
      document.getElementById('welcome-header').innerText = '–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!';
    }

    function logout() {
      localStorage.removeItem('tg_auth');
      showLoginForm();
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('logout-btn').addEventListener('click', logout);
      
      const savedAuth = localStorage.getItem('tg_auth');
      if (savedAuth) {
        const userData = JSON.parse(savedAuth);
        showDashboard(userData.isAdmin);
      } else {
        showLoginForm();
      }
    });
  </script>
</body>
</html>
